[
  {
    "code": "infoBN",
    "query": "SELECT BA.SOBENHAN, BN.TENBENHNHAN,CASE when BN.GIOITINH = 1 THEN N'Nam' ELSE N'Nữ' END GIOITINH,PB.TENPHONGBAN,LT.LUUTRU_ID ,LT.LUUTRU_CURRENT, FORMAT(TN.THOIGIANTIEPNHAN, 'dd/MM/yyyy HH:mm:ss') AS  NGAYTIEPNHAN, BA.TRANGTHAI as TRANGTHAI_BA, TN.TRANGTHAI as TRANGTHAI_TN,TN.SUDUNG_BHTN as BHTN,BN.MAYTE, BN.BENHNHAN_ID,TN.SOTIEPNHAN, TN.TIEPNHAN_ID, BA.BENHAN_ID,FORMAT(BA.THOIGIANRAVIEN, 'dd/MM/yyyy HH:mm:ss') AS TGRAVIEN,BA.CAPCUUDUOI4H AS CCDUOI4H FROM dbo.TT_BENHNHAN BN LEFT JOIN dbo.TT_TIEPNHAN TN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID LEFT JOIN dbo.TT_NOITRU_BENHAN BA ON BA.TIEPNHAN_ID = TN.TIEPNHAN_ID LEFT JOIN dbo.TT_NOITRU_LUUTRU LT ON LT.BENHAN_ID = BA.BENHAN_ID LEFT JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = LT.PHONGBAN_ID WHERE BN.MAYTE = @MAYTE ORDER BY TN.TIEPNHAN_ID,LT.LUUTRU_ID",
    "param": {
      "MAYTE": "",
      "SOBENHAN": ""
    }
  },
  {
    "code": "infoBN1",
    "query": "SELECT BA.SOBENHAN, BN.TENBENHNHAN, PB.TENPHONGBAN,LT.LUUTRU_ID ,LT.LUUTRU_CURRENT, FORMAT(TN.THOIGIANTIEPNHAN, 'dd/MM/yyyy HH:mm:ss') AS  NGAYTIEPNHAN, BA.TRANGTHAI as TRANGTHAI_BA, TN.TRANGTHAI as TRANGTHAI_TN,BN.MAYTE, BN.BENHNHAN_ID,TN.SOTIEPNHAN, TN.TIEPNHAN_ID, BA.BENHAN_ID,FORMAT(BA.THOIGIANRAVIEN, 'dd/MM/yyyy HH:mm:ss') AS TGRAVIEN FROM dbo.TT_BENHNHAN BN LEFT JOIN dbo.TT_TIEPNHAN TN ON TN.BENHNHAN_ID = BN.BENHNHAN_ID LEFT JOIN dbo.TT_NOITRU_BENHAN BA ON BA.TIEPNHAN_ID = TN.TIEPNHAN_ID LEFT JOIN dbo.TT_NOITRU_LUUTRU LT ON LT.BENHAN_ID = BA.BENHAN_ID LEFT JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = LT.PHONGBAN_ID WHERE BA.SOBENHAN = @SOBENHAN ORDER BY TN.TIEPNHAN_ID,LT.LUUTRU_ID",
    "param": {
      "MAYTE": "",
      "SOBENHAN": ""
    }
  },
  {
    "code": "infoBN2",
    "query": "SELECT top 20 BA.SOBENHAN ,BN.TENBENHNHAN ,PB.TENPHONGBAN ,LT.LUUTRU_ID ,LT.LUUTRU_CURRENT ,FORMAT(tn.THOIGIANTIEPNHAN, 'dd/MM/yyyy HH:mm:ss') AS NGAYTIEPNHAN ,BA.TRANGTHAI AS TRANGTHAI_BA ,tn.TRANGTHAI AS TRANGTHAI_TN ,BN.MAYTE ,BN.BENHNHAN_ID ,tn.SOTIEPNHAN ,tn.TIEPNHAN_ID ,BA.BENHAN_ID ,FORMAT(BA.THOIGIANRAVIEN, 'dd/MM/yyyy HH:mm:ss') AS TGRAVIEN FROM dbo.TT_BENHNHAN BN LEFT JOIN dbo.TT_TIEPNHAN tn ON tn.BENHNHAN_ID = BN.BENHNHAN_ID LEFT JOIN dbo.TT_NOITRU_BENHAN BA ON BA.TIEPNHAN_ID = tn.TIEPNHAN_ID LEFT JOIN dbo.TT_NOITRU_LUUTRU LT ON LT.BENHAN_ID = BA.BENHAN_ID LEFT JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = LT.PHONGBAN_ID WHERE BN.MAYTE LIKE N'%' + @MAYTE + '%' OR BN.TENBENHNHAN LIKE N'%' + @MAYTE + '%' ORDER BY tn.TIEPNHAN_ID, LT.LUUTRU_ID",
    "param": {
      "MAYTE": "",
      "SOBENHAN": ""
    }
  },
  {
    "code": "infoBN3",
    "query": "SELECT TOP 20 BA.SOBENHAN ,BN.TENBENHNHAN ,PB.TENPHONGBAN ,LT.LUUTRU_ID ,LT.LUUTRU_CURRENT ,FORMAT(tn.THOIGIANTIEPNHAN, 'dd/MM/yyyy HH:mm:ss') AS NGAYTIEPNHAN ,BA.TRANGTHAI AS TRANGTHAI_BA ,tn.TRANGTHAI AS TRANGTHAI_TN ,BN.MAYTE ,BN.BENHNHAN_ID ,tn.SOTIEPNHAN ,tn.TIEPNHAN_ID ,BA.BENHAN_ID ,FORMAT(BA.THOIGIANRAVIEN, 'dd/MM/yyyy HH:mm:ss') AS TGRAVIEN FROM dbo.TT_BENHNHAN BN LEFT JOIN dbo.TT_TIEPNHAN tn ON tn.BENHNHAN_ID = BN.BENHNHAN_ID LEFT JOIN dbo.TT_NOITRU_BENHAN BA ON BA.TIEPNHAN_ID = tn.TIEPNHAN_ID LEFT JOIN dbo.TT_NOITRU_LUUTRU LT ON LT.BENHAN_ID = BA.BENHAN_ID LEFT JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = LT.PHONGBAN_ID WHERE TN.SOTIEPNHAN = @MAYTE ORDER BY tn.TIEPNHAN_ID, LT.LUUTRU_ID",
    "param": {
      "MAYTE": ""
    }
  },
  {
    "code": "infoBNByID",
    "query": "SELECT BA.SOBENHAN ,BN.TENBENHNHAN ,PB.TENPHONGBAN ,LT.LUUTRU_ID ,LT.LUUTRU_CURRENT ,FORMAT(TN.THOIGIANTIEPNHAN, 'dd/MM/yyyy HH:mm:ss') AS  NGAYTIEPNHAN ,BA.TRANGTHAI AS TRANGTHAI_BA ,tn.TRANGTHAI AS TRANGTHAI_TN ,BN.MAYTE ,BN.BENHNHAN_ID ,TN.SOTIEPNHAN,tn.TIEPNHAN_ID ,BA.BENHAN_ID ,FORMAT(BA.THOIGIANRAVIEN, 'dd/MM/yyyy HH:mm:ss') AS TGRAVIEN FROM dbo.TT_BENHNHAN BN LEFT JOIN dbo.TT_TIEPNHAN tn ON tn.BENHNHAN_ID = BN.BENHNHAN_ID LEFT JOIN dbo.TT_NOITRU_BENHAN BA ON BA.TIEPNHAN_ID = tn.TIEPNHAN_ID LEFT JOIN dbo.TT_NOITRU_LUUTRU LT ON LT.BENHAN_ID = BA.BENHAN_ID LEFT JOIN dbo.TM_PHONGBAN PB ON PB.PHONGBAN_ID = LT.PHONGBAN_ID WHERE 1=1 ",
    "param": {
      "BENHNHAN_ID": "",
      "BENHAN_ID": "",
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "AllDV",
    "query": "SELECT yc.DVYEUCAU_ID, yc.SOPHIEUYEUCAU ,ISNULL(NC.TENNHOMDICHVU, 'KHAC') AS LOAI,ISNULL(NC.MANHOMDICHVU, 'KHAC') as MALOAI,dv.MADICHVU,dv.DICHVU_ID ,dv.TENDICHVU ,YC.HUYYEUCAU AS HUY ,TRANGTHAI ,FORMAT(yc.NGAYGIOYEUCAU, 'dd/MM/yyyy HH:mm:ss') AS NGAYGIOYEUCAU ,tpyc.TENPHONGBAN AS NOIYEUCAU ,tp.TENPHONGBAN AS NOITHUCHIEN ,yc.BENHAN_ID ,yc.DUOCPHEPTHUCHIEN AS DUOCPHEPTH, ISNULL(yc.KHAMCHUYENKHOA,0) as KHAMCK,KB.KHAMBENH_ID as KB_ID,FORMAT(KB.THOIGIANKHAM,'dd/MM/yyyy HH:mm:ss') AS TGKHAM,cast(isnull(dv.HOICHAN,0) AS BIT ) AS HOICHAN,tb.SOPHIEUHOICHAN as SOPHIEUHC FROM TT_DVYEUCAU yc   INNER JOIN TM_DICHVU dv ON yc.DICHVU_ID = dv.DICHVU_ID INNER JOIN TM_NHOMDICHVU tn ON dv.NHOMDICHVU_ID = tn.NHOMDICHVU_ID LEFT JOIN (SELECT CH.NHOMDICHVU_ID ,CH.MANHOMDICHVU ,CH.TENNHOMDICHVU FROM TM_NHOMDICHVU CH WHERE CAP = 1) NC ON NC.MANHOMDICHVU = LEFT(tn.MANHOMDICHVU, 2) LEFT JOIN TM_PHONGBAN tp ON yc.NOITHUCHIEN_ID = tp.PHONGBAN_ID LEFT JOIN TM_PHONGBAN tpyc ON yc.NOIYEUCAU_ID = tpyc.PHONGBAN_ID LEFT JOIN TT_BIENBANHOICHAN tb ON yc.BIENBANHOICHAN_ID = tb.BIENBANHOICHAN_ID LEFT join TT_NOITRU_KHAMBENH KB on yc.DVYEUCAU_ID = KB.DVYEUCAU_ID WHERE yc.TIEPNHAN_ID = @TIEPNHAN_ID ORDER BY NC.NHOMDICHVU_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "DVChuaHT",
    "query": "SELECT yc.DVYEUCAU_ID,NC.TENNHOMDICHVU AS LOAI ,dv.DICHVU_ID ,dv.TENDICHVU ,YC.HUYYEUCAU as HUY,TRANGTHAI ,tp.TENPHONGBAN AS NOITHUCHIEN ,yc.BENHAN_ID ,yc.DUOCPHEPTHUCHIEN as DUOCPHEPTH FROM TT_DVYEUCAU yc   INNER JOIN TM_DICHVU dv ON yc.DICHVU_ID = dv.DICHVU_ID INNER JOIN TM_NHOMDICHVU tn ON dv.NHOMDICHVU_ID = tn.NHOMDICHVU_ID LEFT JOIN ( SELECT CH.NHOMDICHVU_ID,CH.MANHOMDICHVU, CH.TENNHOMDICHVU FROM TM_NHOMDICHVU CH  WHERE CAP = 1) NC ON  NC.MANHOMDICHVU = LEFT(tn.MANHOMDICHVU,2) LEFT JOIN TM_PHONGBAN tp ON yc.NOITHUCHIEN_ID = tp.PHONGBAN_ID WHERE yc.TIEPNHAN_ID = @TIEPNHAN_ID AND (yc.TRANGTHAI != 'HOANTAT' OR yc.DUOCPHEPTHUCHIEN = '0')",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "TTKHAMBENH",
    "query": "SELECT KB.KHAMBENH_ID,dvkb.TENDICHVU, KB.THOIGIANKHAM,ld.DICTIONARY_NAME AS HUONGGIAIQUYET,KB.HUONGGIAIQUYET_ID,KBTT.LOAITOATHUOC,KBTT.HUYTOATHUOC,TT.TOATHUOC_ID,D.TENDUOCDAYDU,KBTT.CHUNGTUPHATTHUOC_ID FROM TT_NGOAITRU_KHAMBENH KB   LEFT JOIN TT_NGOAITRU_TOATHUOC TT   ON TT.KHAMBENH_ID = KB.KHAMBENH_ID LEFT JOIN TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT ON TT.KHAMBENH_TOATHUOC_ID = KBTT.KHAMBENH_TOATHUOC_ID LEFT join TM_DUOC D on D.DUOC_ID = tt.DUOC_ID LEFT join LST_DICTIONARY ld ON KB.HUONGGIAIQUYET_ID = ld.DICTIONARY_ID and ld.DICTIONARY_TYPE_CODE = 'GiaiQuyetKhamBenh' LEFT JOIN TM_DICHVU dvkb ON dvkb.DICHVU_ID = kb.DICHVU_ID where KB.TIEPNHAN_ID = @TIEPNHAN_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "ALLVIENPHI",
    "query": "SELECT VIENPHI_ID, coalesce(td1.TENDICHVU,td.TENDUOCDAYDU,td2.TENDICHVU)  AS NOIDUNG ,COALESCE(VP.DUOC_ID, VP.DICHVU_ID,tnl.DICHVU_CONGCHAMSOC_ID) AS NOIDUNG_ID,CAST(VP.SOLUONG as DECIMAL(10, 3)) as SOLUONG, VP.SOLONHAP_ID,VP.SOBHYT_HUONG_ID, VP.HUY,VP.BENHAN_ID, DATHANHTOAN, DATHUCHIEN,VP.BHYTDONGTIEN AS BNTUTRA, KHONGTHUTIEN, ISNULL(BENHNHAN_PHAITHANHTOAN,0) as BENHNHAN_PHAITHANHTOAN, ISNULL(GIATRI_BENHNHAN_DATHANHTOAN,0) as GIATRI_BENHNHAN_DATHANHTOAN , REF_ID, REF_TABLE,LOAI_CHIPHI, DONGIA_DOANHTHU, THANHTIEN_DOANHTHU, VP.BHYT_DONGIA, VP.BHYT_THANHTIEN, VP.BHYT_THANHTIEN_CHITRA, VP.BHTN_THANHTIEN_CHITRA, VP.MIENGIAM_GIATRI,VP.DANGKY_ID,CASE WHEN VP.REF_TABLE = 'TT_NOITRU_LUUTRUCHITIET' AND VP.DICHVU_ID IS NULL THEN N'GIƯỜNG' WHEN VP.REF_TABLE = 'TT_NOITRU_LUUTRUCHITIET' AND VP.DICHVU_ID IS NOT NULL THEN N'CÔNG CHĂM SÓC' WHEN VP.DICHVU_ID IS NOT NULL THEN UPPER(NDV.TENNHOMDICHVU) WHEN VP.DUOC_ID IS NOT NULL THEN CASE WHEN LD.LOAIVATTU_ID = 'V' THEN N'VẬT TƯ Y TẾ' ELSE CONCAT(N'THUỐC (',LD.LOAIVATTU_ID,')') END ELSE N'KHÁC' END AS LOAI FROM TT_VIENPHI VP   LEFT join TM_DUOC td on VP.DUOC_ID = td.DUOC_ID and VP.REF_TABLE NOT IN ('TT_DVYEUCAU', 'TT_NOITRU_LUUTRUCHITIET') LEFT JOIN TM_DICHVU td1 on VP.DICHVU_ID = td1.DICHVU_ID AND VP.REF_TABLE = 'TT_DVYEUCAU' LEFT join TT_NOITRU_LUUTRUCHITIET tnl ON VP.REF_ID = tnl.LUUTRUCHITIET_ID and VP.REF_TABLE = 'TT_NOITRU_LUUTRUCHITIET' LEFT join TM_DICHVU td2 ON td2.DICHVU_ID = tnl.LOAIGIUONGBENH_ID LEFT JOIN ( SELECT ISNULL(CT.TENNHOMDICHVU,A.TENNHOMDICHVU) AS TENNHOMDICHVU,A.NHOMDICHVU_ID FROM TM_NHOMDICHVU A LEFT JOIN TM_NHOMDICHVU CT ON CT.NHOMDICHVU_ID = A.CAPTREN_ID) NDV ON NDV.NHOMDICHVU_ID = td1.NHOMDICHVU_ID AND VP.DICHVU_ID IS NOT NULL LEFT JOIN TM_LOAIDUOC LD  ON LD.LOAIDUOC_ID = td.LOAIDUOC_ID WHERE TIEPNHAN_ID = @TIEPNHAN_ID AND (@BHYT = 0 OR (@BHYT = 1 AND VP.BHYT_THANHTIEN_CHITRA > 0 )) ORDER BY VP.DONGIA_DOANHTHU",
    "param": {
      "TIEPNHAN_ID": "",
      "THUOC": "",
      "VTYTPT": "",
      "DICHVU": "",
      "GIUONG": "",
      "CCS": "",
      "BHYT": ""
    }
  },
  {
    "code": "SUMVP",
    "query": "DECLARE @TONGTAMUNG DECIMAL(18, 2) = (SELECT SUM(GIATRIHOADON) FROM TT_HOADON  WHERE LOAIHOADON = 'TU' AND DATHANHTOAN = '1' AND HUYHOADON = '0' AND HOANTRA = '0' AND TRANGTHAI <> 'DAHOANUNG' AND TIEPNHAN_ID = @TIEPNHAN_ID AND ((GHICHU NOT LIKE N'%TU-EX%' OR ISNULL(GHICHU, '') = '' OR ISNULL(THUTHEM, 0) = 0))) DECLARE @TTGOI DECIMAL(18, 2) = (SELECT SUM(THANHTIEN_DOANHTHU) FROM TT_VIENPHI  WHERE TIEPNHAN_ID = 5905 AND HUY != '1' AND DANGKY_ID IS NOT NULL) SELECT ISNULL(SUM(THANHTIEN_DOANHTHU),0) AS sTHANHTIEN_DOANHTHU ,ISNULL(SUM(BHTN_THANHTIEN_CHITRA),0)  AS sBHTN_THANHTIEN_CHITRA ,ISNULL(SUM(BHYT_THANHTIEN_CHITRA),0)  AS sBHYT_THANHTIEN_CHITRA ,ISNULL(SUM(MIENGIAM_GIATRI),0)  AS sMIENGIAM_GIATRI ,ISNULL(SUM(BENHNHAN_PHAITHANHTOAN),0)  AS sBENHNHAN_PHAITHANHTOAN ,ISNULL(SUM(GIATRI_BENHNHAN_DATHANHTOAN),0)  AS sGIATRI_BENHNHAN_DATHANHTOAN ,ISNULL(@TONGTAMUNG, 0) AS sTAMUNG ,ISNULL(SUM(THANHTIEN_DOANHTHU), 0) - ISNULL(SUM(BHTN_THANHTIEN_CHITRA), 0) - ISNULL(SUM(BHYT_THANHTIEN_CHITRA),0) -  ISNULL(SUM(MIENGIAM_GIATRI), 0) -ISNULL(@TONGTAMUNG, 0) - ISNULL(SUM(GIATRI_BENHNHAN_DATHANHTOAN),0) AS SCONLAI,ISNULL(@TTGOI,0) AS sGOI FROM TT_VIENPHI  WHERE TIEPNHAN_ID = @TIEPNHAN_ID AND HUY != '1'",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "CSRIPTVP",
    "query": "SELECT VIENPHI_ID, coalesce(td1.TENDICHVU,td.TENDUOCDAYDU,td2.TENDICHVU)  AS NOIDUNG , VP.SOLONHAP_ID, VP.HUY,VP.BENHAN_ID,\n\tDATHANHTOAN,\n\tDATHUCHIEN,\n\tKHONGTHUTIEN,\n\tBENHNHAN_PHAITHANHTOAN,\n\tGIATRI_BENHNHAN_DATHANHTOAN,\n\tREF_ID,\n\tREF_TABLE,\n\tDONGIA_DOANHTHU,\n\tTHANHTIEN_DOANHTHU,\n\tVP.BHYT_DONGIA,\n\tVP.BHYT_THANHTIEN,\n\tVP.BHYT_THANHTIEN_CHITRA,\n\t *\nFROM TT_VIENPHI VP\nLEFT join TM_DUOC td on VP.DUOC_ID = td.DUOC_ID and VP.REF_TABLE NOT IN ('TT_DVYEUCAU', 'TT_NOITRU_LUUTRUCHITIET')\nLEFT JOIN TM_DICHVU td1 on VP.DICHVU_ID = td1.DICHVU_ID AND VP.REF_TABLE = 'TT_DVYEUCAU'\nLEFT join TT_NOITRU_LUUTRUCHITIET tnl ON VP.REF_ID = tnl.LUUTRUCHITIET_ID and VP.REF_TABLE = 'TT_NOITRU_LUUTRUCHITIET'\nLEFT join TM_DICHVU td2 ON td2.DICHVU_ID = tnl.LOAIGIUONGBENH_ID\nWHERE VP.TIEPNHAN_ID = @TIEPNHAN_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "SKHAMBENH_ID",
    "query": "SELECT FORMAT(CASE WHEN KB.ISYLENHVTYT = '1' THEN KB.THOIGIANKHAM ELSE KB.THOIGIANBATDAU end, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANKHAM,KB.TRANGTHAIYLENH , KB.KHAMBENH_ID,cast(KB.KHAMCHUYENKHOA AS BIT) AS KHAMCK,KB.DVYEUCAU_ID AS DVYC_ID,KB.SOGIAYHENTK,FORMAT(KB.NGAYTAIKHAM,'dd/MM/yyyy HH:mm:ss') AS NGAYTAIKHAM ,tn.TENNHANVIEN AS THUTRUONG FROM TT_NOITRU_KHAMBENH KB LEFT JOIN TM_NHANVIEN tn on tn.NHANVIEN_ID = KB.THUTRUONG_ID  WHERE KB.BENHAN_ID = @BENHAN_ID AND (@THOIGIANKHAM is null or CONVERT(DATE,CASE WHEN KB.ISYLENHVTYT = '1' THEN KB.THOIGIANKHAM ELSE KB.THOIGIANBATDAU END) = CONVERT(DATE,@THOIGIANKHAM) ) AND ((@THUOC = 1 AND KB.ISYLENHVTYT = '0') or (@VTYT = 1 AND KB.ISYLENHVTYT = '1'))ORDER BY KB.THOIGIANBATDAU",
    "param": {
      "BENHAN_ID": "",
      "THOIGIANKHAM": "",
      "THUOC": "",
      "VTYT": ""
    }
  },
  {
    "code": "STHUOCNOITRU",
    "query": "SELECT KB.KHAMBENH_ID ,CAST(NHOMHUOCPHA AS INT) AS TPHA , td.DUOC_ID ,td.TENDUOCDAYDU ,CAST(tnt.SOLUONGTHUCLINH AS DECIMAL(10, 3)) AS SLTHUCLINH ,tnt.TOATHUOC_ID ,tnt.TINHTIEN ,KB.LOAITOATHUOC AS LOAITT ,KB.THUOCRAVIEN AS THUOCRV ,CAST(tnt.SOLAN AS INT) AS SOLAN ,tnt.PHAMVI_ID ,tnt.PHONGBANRATOA_ID AS PBRATOA,tp.TENPHONGBAN,KB.KHODUOC_ID,tk.TENKHO AS KHODUOC,tnt.KHOTAO_ID,tk1.TENKHO AS KHOTAO,tnt.CHUNGTU_ID FROM TT_NOITRU_KHAMBENH KB   INNER JOIN TT_NOITRU_TOATHUOC tnt   ON KB.KHAMBENH_ID = tnt.KHAMBENH_ID AND tnt.TIEPNHAN_ID = @TIEPNHAN_ID LEFT JOIN TM_DUOC td ON tnt.DUOC_ID = td.DUOC_ID LEFT JOIN TM_KHODUOC tk ON KB.KHODUOC_ID = tk.KHODUOC_ID LEFT JOIN TM_KHODUOC tk1 ON tnt.KHOTAO_ID = tk1.KHODUOC_ID LEFT JOIN TM_PHONGBAN tp ON tnt.PHONGBANRATOA_ID = tp.PHONGBAN_ID WHERE tnt.KHAMBENH_ID = @KHAMBENH_ID ORDER BY tnt.TOATHUOC_ID",
    "param": {
      "KHAMBENH_ID": ""
    }
  },
  {
    "code": "SCHUNGTU",
    "query": "SELECT LOAI = CASE WHEN PL.COSO = 0 THEN N'Lĩnh người bệnh' WHEN PL.COSO = 1 THEN N'Lĩnh bù cơ số' WHEN PL.COSO = 2 THEN N'Lĩnh nội bộ' else 'Phiếu Lĩnh' END, MA = 'PL', CT.SOLONHAP_ID, FORMAT(PL.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss') AS NGAYCHUNGTU, PL.MACHUNGTU, PL.CHUNGTU_ID, CT.CHUNGTUCHITIET_ID, PL.KHOXUAT_ID AS KX_ID,kx.TENKHO AS KHOXUAT, PL.KHONHAP_ID  AS KN_ID,kn.TENKHO AS KHONHAP ,CAST(CT.SOLUONGYEUCAU AS DECIMAL(10, 3)) AS SOLUONGYEUCAU ,CAST(CT.SOLUONGDAXUAT AS DECIMAL(10, 3)) AS SOLUONGDAXUAT ,'' AS DIENGIAINGHIEPVUPHATSINH, PL.CHUNGTULIENQUAN_ID FROM TT_DUOC_PHIEULINH_CHITIET CT INNER JOIN TT_DUOC_PHIEULINH PL ON PL.CHUNGTU_ID = CT.CHUNGTU_ID LEFT JOIN TM_KHODUOC kn ON kn.KHODUOC_ID = PL.KHONHAP_ID LEFT JOIN TM_KHODUOC kx ON kx.KHODUOC_ID = PL.KHOXUAT_ID WHERE CT.TOATHUOCNOITRU_ID = @TOATHUOC_ID and CT.REF_TABLE = 'TT_NOITRU_TOATHUOC' UNION ALL SELECT ld.DICTIONARY_NAME as LOAI,tdc.MUCDICHCHUNGTU_CODE as MA, CT.SOLONHAP_ID, FORMAT(tdc.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss') as NGAYCHUNGTU,tdc.MACHUNGTU,tdc.CHUNGTU_ID, CT.CHUNGTUCHITIET_ID, tdc.KHOXUAT_ID as KX_ID,kx.TENKHO AS KHOXUAT, tdc.KHONHAP_ID as KN_ID,kn.TENKHO AS KHONHAP, CAST(CT.SOLUONGYEUCAU as DECIMAL(10, 3)) as SOLUONGYEUCAU, CAST(CT.SOLUONGDAXUAT as DECIMAL(10, 3)) as SOLUONGDAXUAT, tdc.DIENGIAINGHIEPVUPHATSINH,tdc.CHUNGTULIENQUAN_ID FROM TT_DUOC_CHUNGTU_CHITIET CT   INNER join TT_DUOC_CHUNGTU tdc   ON CT.CHUNGTU_ID = tdc.CHUNGTU_ID INNER join LST_DICTIONARY ld   on ld.DICTIONARY_ID = tdc.MUCDICHCHUNGTU_ID AND ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' LEFT JOIN TM_KHODUOC kn ON kn.KHODUOC_ID = tdc.KHONHAP_ID LEFT JOIN TM_KHODUOC kx ON kx.KHODUOC_ID = tdc.KHOXUAT_ID where CT.TOATHUOCNOITRU_ID =  @TOATHUOC_ID",
    "param": {
      "TOATHUOC_ID": ""
    }
  },
  {
    "code": "GETSINHIEU",
    "query": "SELECT DT.LOAI ,DT.KHAMBENH_SINHHIEU_ID ,DT.KHAMBENH_ID ,DT.TENNHANVIEN as NGUOIDO ,DT.THOIGIANDO ,DT.CANNANG FROM (SELECT N'NGOẠI TRÚ' AS LOAI ,KHAMBENH_SINHHIEU_ID ,KHAMBENH_ID ,FORMAT(SH.THOIGIANDO, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANDO ,SH.CANNANG ,SH.THOIGIANDO AS THOIGIANDO_DESC,tn.TENNHANVIEN FROM TT_NGOAITRU_KHAMBENH_SINHHIEU SH INNER JOIN TM_NHANVIEN tn ON tn.NHANVIEN_ID = SH.NGUOIDO_ID WHERE TIEPNHAN_ID = @TIEPNHAN_ID UNION ALL SELECT N'NỘI TRÚ' AS LOAI ,KHAMBENH_SINHHIEU_ID ,SH.KHAMBENH_ID ,FORMAT(SH.THOIGIANDO, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANDO ,SH.CANNANG ,SH.THOIGIANDO AS THOIGIANDO_DESC,tn.TENNHANVIEN FROM TT_NOITRU_KHAMBENH_SINHHIEU SH INNER JOIN TM_NHANVIEN tn ON tn.NHANVIEN_ID = SH.NGUOIDO_ID WHERE TIEPNHAN_ID = @TIEPNHAN_ID UNION ALL SELECT N'HSBA CẤP CỨU' AS LOAI ,BENHAN_ID ,BENHAN_ID ,FORMAT(BA.NGAYTAO, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANDO ,BA.CANNANG ,BA.NGAYTAO AS THOIGIANDO_DESC ,null AS TENNHANVIEN FROM TT_NOITRU_BENHAN BA where BA.TIEPNHAN_ID = @TIEPNHAN_ID and BA.LOAIBENHAN_ID = 1 and BA.TRANGTHAI <> 'DAHUY') DT ORDER BY DT.THOIGIANDO DESC",
    "param": {
      "BENHAN_ID": ""
    }
  },
  {
    "code": "STHYL",
    "query": "SELECT THYL_ID as ID,LIEUTHUCHIEN as LIEU,TRANGTHAITHUCHIENYLENH as TRANGTHAI,TENTHUOC , CAST(SLXUAT AS DECIMAL(10, 3)) AS SLXUAT ,DONVITINH ,FORMAT(THOIGIANCHIDINH, 'dd/MM/yyyy HH:mm:ss') THOIGIANCHIDINH ,FORMAT(THOIGIANTHUCHIEN, 'dd/MM/yyyy HH:mm:ss') THOIGIANTHUCHIEN,NGUOITHUCHIEN ,LYDO,NGUNGTULAN,TH.CHUNGTUCHITIET_ID as CHUNGTUCT_ID,tdc.MACHUNGTU as CHUNGTUXUAT FROM TT_NOITRU_THUCHIENYLENH TH LEFT join TT_DUOC_CHUNGTU_CHITIET tdcc on TH.CHUNGTUCHITIET_ID = tdcc.CHUNGTUCHITIET_ID LEFT join TT_DUOC_CHUNGTU tdc ON tdcc.CHUNGTU_ID = tdc.CHUNGTU_ID WHERE TOATHUOC_ID = @TOATHUOC_ID ORDER BY THYL_ID",
    "param": {
      "TOATHUOC_ID": ""
    }
  },
  {
    "code": "SDANGTT",
    "query": "SELECT FORMAT(TH.THOIGIANKHAM, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANKHAM, TH.TOATHUOC_ID, TH.TENTHUOC, TH.SLXUAT_THYL, isnull(XSD.SOLUONGDAXUAT_CHUNGTU,0) AS SOLUONGDAXUAT_CHUNGTU FROM  ( SELECT tnk.THOIGIANKHAM, TH.TOATHUOC_ID, sum(SLXUAT) as SLXUAT_THYL ,TENTHUOC FROM TT_NOITRU_THUCHIENYLENH TH LEFT JOIN TT_NOITRU_TOATHUOC tnt ON TH.TOATHUOC_ID = tnt.TOATHUOC_ID LEFT JOIN TT_NOITRU_KHAMBENH tnk ON tnt.KHAMBENH_ID = tnk.KHAMBENH_ID where TH.TIEPNHAN_ID = @TIEPNHAN_ID GROUP BY TH.TOATHUOC_ID,tnk.THOIGIANKHAM,TENTHUOC ) TH left JOIN ( SELECT tdc.MUCDICHCHUNGTU_CODE, CT.TOATHUOCNOITRU_ID,sum(isnull(CT.SOLUONGDAXUAT,0)) AS SOLUONGDAXUAT_CHUNGTU FROM TT_DUOC_CHUNGTU_CHITIET CT INNER join TT_DUOC_CHUNGTU tdc ON CT.CHUNGTU_ID = tdc.CHUNGTU_ID where (ct.TIEPNHAN_ID = @TIEPNHAN_ID OR tdc.TIEPNHAN_ID = @TIEPNHAN_ID) and tdc.MUCDICHCHUNGTU_CODE = 'X13' GROUP BY CT.TOATHUOCNOITRU_ID, tdc.MUCDICHCHUNGTU_CODE) XSD ON TH.TOATHUOC_ID = XSD.TOATHUOCNOITRU_ID WHERE isnull(TH.SLXUAT_THYL,0) <> isnull(XSD.SOLUONGDAXUAT_CHUNGTU,0)",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "Get_CLSKETQUA",
    "query": "SELECT KQCT.CLSKETQUACHITIET_ID AS KQCT_ID,tc.SOPHIEUXETNGHIEM ,tc.CLSKETQUA_ID AS KQ_ID ,FORMAT(tc.THOIGIANTHUCHIEN, 'dd/MM/yyyy HH:mm:ss') AS TGTH ,FORMAT(tc.THOIGIANCHUPPHIM, 'dd/MM/yyyy HH:mm:ss') AS TGCHUPPHIM ,tc.MOTA_TEXT,isnull(tc.KETLUAN,KQCT.KETQUA) AS KETQUA,CONCAT(tc.BACSITHUCHIEN_ID, ' - ', tn2.TENNHANVIEN, ' - ',tn2.MA_BAC_SI) BS_THUCHIEN ,CONCAT(tc.BACSIKETLUAN_ID, ' - ', tn.TENNHANVIEN, ' - ',tn.MA_BAC_SI) AS BS_KETLUAN,CONCAT(tc.NGUOIDOCKETQUA_ID, ' - ', tn1.TENNHANVIEN, ' - ',tn1.MA_BAC_SI) AS BS_DOCKQ, FORMAT(tc.THOIGIANKHOADULIEU, 'dd/MM/yyyy HH:mm:ss') AS TGKHOA ,concat(tc.NGUOIKHOA_ID,' - ',tc.TENNGUOIKHOA) AS NGUOIKHOA ,concat(tc.THIETBI_ID,' - ',tt.MATHIETBI) THIET_BI FROM TT_CLSKETQUACHITIET KQCT INNER JOIN TT_CLSKETQUA tc ON KQCT.CLSKETQUA_ID = tc.CLSKETQUA_ID AND tc.TIEPNHAN_ID = @TIEPNHAN_ID LEFT join TM_NHANVIEN tn on tc.BACSIKETLUAN_ID = tn.NHANVIEN_ID LEFT join TM_NHANVIEN tn1 on tc.NGUOIDOCKETQUA_ID = tn1.NHANVIEN_ID LEFT join TM_NHANVIEN tn2 on tn2.NHANVIEN_ID = tc.BACSITHUCHIEN_ID LEFT JOIN TM_THIETBI tt on tc.THIETBI_ID = tt.THIETBI_ID WHERE KQCT.DVYEUCAU_ID = @DVYEUCAU_ID",
    "param": {
      "TIEPNHAN_ID": "",
      "DVYEUCAU_ID": ""
    }
  },
  {
    "code": "GET_DVKKQ",
    "query": "SELECT NGUOITHUCHIEN_ID, CONCAT(tn.TENNHANVIEN, ' - ',tn.MA_BAC_SI) AS NGUOITHUCHIEN,FORMAT(yc.NGAYTHUCHIEN, 'dd/MM/yyyy HH:mm:ss') as NGAYTHUCHIEN FROM TT_DVYEUCAU YC LEFT join TM_NHANVIEN tn on tn.NHANVIEN_ID = YC.NGUOITHUCHIEN_ID where YC.TIEPNHAN_ID = @TIEPNHAN_ID AND YC.DVYEUCAU_ID = @DVYEUCAU_ID",
    "param": {
      "TIEPNHAN_ID": "",
      "DVYEUCAU_ID": ""
    }
  },
  {
    "code": "GET_PTTT",
    "query": "SELECT tp.PHAUTHUAT_ID AS PT_ID ,tp.SOPHIEUPHAUTHUAT AS SOPHIEU ,FORMAT(tp.THOIGIANBATDAU, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANBATDAU ,FORMAT(tp.THOIGIANKETTHUC, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANKETTHUC ,EKIP.EKIP FROM TT_PHAUTHUAT_YEUCAU YC INNER JOIN TT_PHAUTHUAT tp ON YC.PHAUTHUAT_ID = tp.PHAUTHUAT_ID LEFT JOIN (SELECT STRING_AGG(concat(tn.TENNHANVIEN,' (',ld.DICTIONARY_NAME,')'),char(10)) AS EKIP, tpe.PHAUTHUAT_ID,tpe.DVYEUCAU_ID FROM  TT_PHAUTHUAT_EKIP tpe INNER join LST_DICTIONARY ld ON ld.DICTIONARY_ID = tpe.VAITRO_ID and ld.DICTIONARY_TYPE_CODE = 'KipMo_VaiTro' INNER join TM_NHANVIEN tn on tpe.NHANVIEN_ID = tn.NHANVIEN_ID WHERE DVYEUCAU_ID = @DVYEUCAU_ID GROUP BY  tpe.PHAUTHUAT_ID,tpe.DVYEUCAU_ID ) EKIP ON EKIP.PHAUTHUAT_ID = YC.PHAUTHUAT_ID AND EKIP.DVYEUCAU_ID = YC.DVYEUCAU_ID WHERE YC.DVYEUCAU_ID = @DVYEUCAU_ID",
    "param": {
      "TIEPNHAN_ID": "",
      "DVYEUCAU_ID": ""
    }
  },
  {
    "code": "GET_KB",
    "query": "SELECT KB.KHAMBENH_ID AS KB_ID ,FORMAT(KB.THOIGIANKHAM, 'dd/MM/yyyy HH:mm:ss') AS TGKHAM  ,FORMAT(KB.THOIGIANKETTHUCKHAM, 'dd/MM/yyyy HH:mm:ss') AS TGKETTHUCKHAM, CONCAT(tn.MANHANVIEN,' - ',tn.TENNHANVIEN,' (',tn.MA_BAC_SI,')') AS BACSIKHAM ,tc.TENCHUYENKHOA ,ICD_CHINH = CONCAT(ti.TENICD,' (',ti.MAICD,')') ,ICD_PHU = (SELECT STRING_AGG(CONCAT(ti1.TENICD,' (',ti1.MAICD,')'),';') FROM TT_NGOAITRU_KHAMBENH_ICD a INNER JOIN TM_ICD ti1 ON a.ICD_ID = ti1.ICD_ID where KB.KHAMBENH_ID = KHAMBENH_ID) ,ld.DICTIONARY_NAME AS HUONGGIAIQUYET FROM TT_DVYEUCAU YC INNER JOIN TT_NGOAITRU_KHAMBENH KB ON YC.KHAMBENH_NGOAITRU_ID = KB.KHAMBENH_ID LEFT join TM_ICD ti ON KB.CHANDOANICD_ID = ti.ICD_ID LEFT join TM_NHANVIEN tn ON KB.BACSIKHAM_ID = tn.NHANVIEN_ID LEFT join LST_DICTIONARY ld ON KB.HUONGGIAIQUYET_ID = ld.DICTIONARY_ID and ld.DICTIONARY_TYPE_CODE = 'GiaiQuyetKhamBenh' LEFT join TM_CHUYENKHOA tc on KB.CHUYENKHOA_ID = tc.CHUYENKHOA_ID WHERE DVYEUCAU_ID = @DVYEUCAU_ID",
    "param": {
      "TIEPNHAN_ID": "",
      "DVYEUCAU_ID": ""
    }
  },
  {
    "code": "DV_CK",
    "query": "SELECT A.NOIDUNG,A.BHYT_THANHTIEN_CHITRA , CONCAT(B.STT,' - ', B.KHAMBENH_ID, ' - ',td.TENDICHVU,' - ',  FORMAT( B.BHYT_THANHTIEN_CHITRA, 'N','vi-VN')) AS STT FROM ( SELECT  BHYT_THANHTIEN_CHITRA,ISNULL(dv.TENDICHVU,td.TENDUOCDAYDU) AS NOIDUNG, CASE WHEN VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC' THEN VP.KHAMBENH_ID ELSE ISNULL(YC.KHAMBENH_ID, YC.KHAMBENH_NGOAITRU_ID) END AS KHAMBENH_ID FROM TT_VIENPHI VP LEFT JOIN TT_DVYEUCAU YC ON YC.DVYEUCAU_ID = VP.REF_ID AND VP.REF_TABLE = 'TT_DVYEUCAU' AND YC.BENHAN_ID is NULL LEFT join TM_DICHVU dv on dv.DICHVU_ID = vp.DICHVU_ID LEFT join TM_DUOC td on VP.DUOC_ID = td.DUOC_ID WHERE VP.TIEPNHAN_ID = @TIEPNHAN_ID  and VP.REF_TABLE in ('TT_DVYEUCAU','TT_NGOAITRU_TOATHUOC') AND VP.HUY <> '1' AND (YC.KHAMBENH_ID IS NOT NULL OR YC.KHAMBENH_NGOAITRU_ID IS NOT NULL OR VP.KHAMBENH_ID IS NOT NULL) ) A INNER JOIN ( SELECT  ROW_NUMBER() OVER (ORDER BY D.BHYT_THANHTIEN_CHITRA DESC) AS STT, D.KHAMBENH_ID,BHYT_THANHTIEN_CHITRA FROM ( SELECT SUM(BHYT_THANHTIEN_CHITRA) AS BHYT_THANHTIEN_CHITRA ,CASE WHEN VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC' THEN VP.KHAMBENH_ID ELSE ISNULL(YC.KHAMBENH_ID, YC.KHAMBENH_NGOAITRU_ID) END AS KHAMBENH_ID FROM TT_VIENPHI VP LEFT JOIN TT_DVYEUCAU YC ON YC.DVYEUCAU_ID = VP.REF_ID AND VP.REF_TABLE = 'TT_DVYEUCAU' AND YC.BENHAN_ID is NULL WHERE VP.TIEPNHAN_ID = @TIEPNHAN_ID  and VP.REF_TABLE in ('TT_DVYEUCAU','TT_NGOAITRU_TOATHUOC') AND VP.HUY <> '1' AND (YC.KHAMBENH_ID IS NOT NULL OR YC.KHAMBENH_NGOAITRU_ID IS NOT NULL OR VP.KHAMBENH_ID IS NOT NULL) GROUP BY CASE WHEN VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC' THEN VP.KHAMBENH_ID ELSE ISNULL(YC.KHAMBENH_ID, YC.KHAMBENH_NGOAITRU_ID) END ) D ) B on A.KHAMBENH_ID = B.KHAMBENH_ID LEFT join TT_NGOAITRU_KHAMBENH tnk on tnk.KHAMBENH_ID = B.KHAMBENH_ID LEFT join TM_DICHVU td on tnk.DICHVU_ID = td.DICHVU_ID ORDER BY B.STT",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "sREPORT",
    "query": "SELECT TOP 100 a.REPORT_ID,a.REPORT_CODE,a.REPORT_NAME,a.REPORT_FILE,a.PROCEDURE_FILE,a.DATASET_LIST,a.IS_PHIEU,a.IS_KYSO,a.IS_KYDIENTU FROM TM_REPORT a   WHERE a.REPORT_NAME LIKE '%' + @KEY + '%' OR a.REPORT_CODE LIKE '%' + @KEY + '%' OR a.REPORT_FILE LIKE '%' + @KEY + '%' OR a.PROCEDURE_FILE LIKE '%' + @KEY + '%' ORDER BY a.REPORT_ID",
    "param": {
      "KEY": ""
    }
  },
  {
    "code": "sSTORED",
    "query": "select TOP 10 '' REPORT_ID ,'' REPORT_CODE ,'' REPORT_NAME ,'' REPORT_FILE ,SPECIFIC_NAME PROCEDURE_FILE from information_schema.routines where routine_type = 'PROCEDURE' AND SPECIFIC_NAME LIKE '%' + @KEY + '%'",
    "param": {
      "KEY": ""
    }
  },
  {
    "code": "sTGLIEU",
    "query": "drop table if EXISTS  #TEMP SELECT THOIGIANLIEU1,THOIGIANLIEU2,THOIGIANLIEU3,THOIGIANLIEU4,THOIGIANLIEU5,THOIGIANLIEU6 INTO #TEMP FROM TT_NOITRU_TOATHUOC   where TOATHUOC_ID = @TOATHUOC_ID SELECT '1' AS LIEU,\tFORMAT(THOIGIANLIEU1, 'dd/MM/yyyy HH:mm:ss') AS [VALUE] FROM  #TEMP UNION ALL SELECT '2'\t,FORMAT(THOIGIANLIEU2, 'dd/MM/yyyy HH:mm:ss') FROM  #TEMP UNION ALL SELECT '3'\t,\tFORMAT(THOIGIANLIEU3, 'dd/MM/yyyy HH:mm:ss') FROM  #TEMP UNION ALL SELECT '4'\t,FORMAT(THOIGIANLIEU4, 'dd/MM/yyyy HH:mm:ss') FROM  #TEMP UNION ALL SELECT '5'\t,FORMAT(THOIGIANLIEU5, 'dd/MM/yyyy HH:mm:ss') FROM  #TEMP UNION ALL SELECT '6'\t,\tFORMAT(THOIGIANLIEU6, 'dd/MM/yyyy HH:mm:ss') FROM  #TEMP",
    "param": {
      "TOATHUOC_ID": ""
    }
  },
  {
    "code": "sCTX13",
    "query": "SELECT ROW_NUMBER() OVER (\tORDER BY tdc.CHUNGTU_ID) STT, tdc.DIENGIAINGHIEPVUPHATSINH as DIENGIAI, CAST(CT.SOLUONGDAXUAT AS DECIMAL(10, 3)) AS SLXUAT, CT.SOLONHAP_ID, tdc.MACHUNGTU, tdc.CHUNGTU_ID, CT.CHUNGTUCHITIET_ID, tdc.KHOXUAT_ID AS KX_ID, kx.TENKHO AS KHOXUAT FROM TT_DUOC_CHUNGTU_CHITIET CT   INNER JOIN TT_DUOC_CHUNGTU tdc   ON CT.CHUNGTU_ID = tdc.CHUNGTU_ID LEFT JOIN TM_KHODUOC kx ON kx.KHODUOC_ID = tdc.KHOXUAT_ID WHERE CT.TOATHUOCNOITRU_ID = @TOATHUOC_ID and tdc.MUCDICHCHUNGTU_CODE IN ('X12','X13')",
    "param": {
      "TOATHUOC_ID": ""
    }
  },
  {
    "code": "SCXUATTH",
    "query": "DROP TABLE IF EXISTS #temp; SELECT kb.KHAMBENH_ID ,tt.DUOC_ID ,tt.TOATHUOC_ID ,FORMAT(kb.THOIGIANKHAM, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANKHAM ,D.TENDUOCDAYDU ,ISNULL(tt.SOLUONGTHUCLINH, tt.SOLUONG) SOLUONG ,ISNULL(ctXuat.SOLUONGXUAT, 0) SOLUONGXUAT ,ISNULL(Ngung.SOLUONGNGUNG, 0) SOLUONGNGUNG ,kb.ISYLENHVTYT ,kb.RAVIEN,kb.TRANGTHAIYLENH,ba.SOBENHAN INTO #temp FROM TT_NOITRU_BENHAN ba JOIN TT_NOITRU_KHAMBENH kb ON ba.BENHAN_ID = kb.BENHAN_ID AND ba.TIEPNHAN_ID = @TIEPNHAN_ID JOIN TT_NOITRU_TOATHUOC tt ON tt.KHAMBENH_ID = kb.KHAMBENH_ID AND HUYTOATHUOC != '1' JOIN TM_DUOC D ON D.DUOC_ID = tt.DUOC_ID LEFT JOIN (SELECT ct.TOATHUOCNOITRU_ID ,SUM(ct.SOLUONGDAXUAT) AS SoLuongXuat FROM TT_DUOC_CHUNGTU ctu JOIN TT_DUOC_CHUNGTU_CHITIET ct ON ctu.CHUNGTU_ID = ct.CHUNGTU_ID WHERE (ct.TIEPNHAN_ID = @TIEPNHAN_ID OR ctu.TIEPNHAN_ID = @TIEPNHAN_ID) AND ctu.MUCDICHCHUNGTU_CODE IN ('X13', 'X12') GROUP BY ct.TOATHUOCNOITRU_ID) AS ctXuat ON tt.TOATHUOC_ID = ctXuat.TOATHUOCNOITRU_ID LEFT JOIN (SELECT ct.TOATHUOC_ID ,SUM(ct.SOLUONG) AS SoLuongNgung FROM TT_NOITRU_TRATHUOC tra JOIN TT_NOITRU_TRATHUOC_CHITIET ct ON tra.TRATHUOC_ID = ct.TRATHUOC_ID JOIN TT_NOITRU_TOATHUOC tnt ON ct.TOATHUOC_ID = tnt.TOATHUOC_ID WHERE tnt.TIEPNHAN_ID = @TIEPNHAN_ID GROUP BY ct.TOATHUOC_ID) AS Ngung ON tt.TOATHUOC_ID = Ngung.TOATHUOC_ID LEFT JOIN (SELECT yl.TOATHUOC_ID ,SUM(yl.SLXUAT) AS SoLuongTThucHien FROM TT_NOITRU_THUCHIENYLENH yl JOIN TT_NOITRU_KHAMBENH kb ON yl.KHAMBENH_ID = kb.KHAMBENH_ID WHERE yl.TIEPNHAN_ID = @TIEPNHAN_ID GROUP BY yl.TOATHUOC_ID) AS ThucHienYL ON tt.TOATHUOC_ID = ThucHienYL.TOATHUOC_ID WHERE ISNULL(LOAITOATHUOC, '') NOT IN ('MN') SELECT t.SOBENHAN,t.THOIGIANKHAM,KHAMBENH_ID,t.TOATHUOC_ID ,t.DUOC_ID ,t.TENDUOCDAYDU ,SUM(SOLUONG) AS SLTHUCLINH ,SUM(SOLUONGNGUNG) as SOLUONGNGUNG ,SL_CHUAXUAT = CAST((SUM(SOLUONG) - (SUM(SOLUONGXUAT) + SUM(SOLUONGNGUNG))) AS DECIMAL(10, 3)) ,SL_CHUATH = CAST(CASE WHEN t.ISYLENHVTYT = 0 AND t.RAVIEN = 0 THEN SUM(SOLUONG) - SUM(ISNULL(SOLUONGXUAT, 0)) - SUM(ISNULL(SOLUONGNGUNG, 0)) ELSE 0 END AS DECIMAL(10, 3)) ,t.TRANGTHAIYLENH FROM #temp AS t GROUP BY t.SOBENHAN,t.KHAMBENH_ID ,t.DUOC_ID ,t.ISYLENHVTYT ,t.RAVIEN ,t.TOATHUOC_ID ,t.THOIGIANKHAM ,t.TENDUOCDAYDU,t.TRANGTHAIYLENH HAVING (SUM(SOLUONG) - (SUM(SOLUONGXUAT) + SUM(SOLUONGNGUNG))) > 0 OR CASE WHEN t.ISYLENHVTYT = 0 AND t.RAVIEN = 0 THEN SUM(SOLUONG) - SUM(ISNULL(SOLUONGXUAT, 0)) - SUM(ISNULL(SOLUONGNGUNG, 0)) ELSE 0 END > 0",
    "param": {
      "TIEPNHAN_ID": "",
      "BENHAN_ID": ""
    }
  },
  {
    "code": "CHUACOLOVP",
    "query": "SELECT VIENPHI_ID ,D.TENDUOCDAYDU AS NOIDUNG ,ISNULL(VP.DUOC_ID, VP.DICHVU_ID) AS NOIDUNG_ID ,CAST(VP.SOLUONG AS DECIMAL(10, 3)) AS SOLUONG ,VP.SOLONHAP_ID ,VP.HUY ,VP.BENHAN_ID ,DATHANHTOAN ,DATHUCHIEN ,KHONGTHUTIEN ,BENHNHAN_PHAITHANHTOAN ,GIATRI_BENHNHAN_DATHANHTOAN ,REF_ID ,REF_TABLE ,LOAI_CHIPHI ,DONGIA_DOANHTHU ,THANHTIEN_DOANHTHU ,VP.BHYT_DONGIA ,VP.BHYT_THANHTIEN ,VP.BHYT_THANHTIEN_CHITRA ,VP.BHTN_THANHTIEN_CHITRA ,VP.MIENGIAM_GIATRI, VP.DANGKY_ID from TT_VIENPHI VP   INNER JOIN TM_DUOC D ON D.DUOC_ID = vp.DUOC_ID where VP.TIEPNHAN_ID = @TIEPNHAN_ID and VP.SOLONHAP_ID is null and VP.DUOC_ID is not null and VP.HUY = '0' and VP.SOLUONG > 0",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "INSERTTHYL",
    "query": "sp_ToolKit_InsertTHYL",
    "param": {
      "TOATHUOC_ID": "",
      "NGUOITHUCHIEN": "",
      "BENHVIEN_ID": ""
    }
  },
  {
    "code": "TINHALL",
    "query": "BIL_TINHLAICHIPHI_ALL",
    "param": {
      "TIEPNHAN_ID": "",
      "BENHAN_ID": "",
      "BENHVIEN_ID": ""
    }
  },
  {
    "code": "THETIEPNHAN",
    "query": "SELECT TN.TIEPNHAN_ID,SOBHYT, BHYTTUNGAY, BHYTDENNGAY ,TN.DOITUONG_ID, DT.TENDOITUONG,CHK_MIENDONGCHITRA, NGAYBATDAU5NAM, KHUVUCSONG_ID,TN.BENHVIEN_KCB, BV.TENBENHVIEN FROM  TT_TIEPNHAN TN   INNER JOIN TM_DOITUONG DT ON DT.DOITUONG_ID = TN.DOITUONG_ID LEFT JOIN TM_BENHVIEN BV ON BV.MABENHVIEN =  TN.BENHVIEN_KCB WHERE TIEPNHAN_ID = @TIEPNHAN_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "THEBHYT",
    "query": "SELECT SOBHYT_HUONG_ID,SOBHYT, BHYTTUNGAY, BHYTDENNGAY , DOITUONG_ID , ST.TAMNGUNG, CHK_MIENDONGCHITRA, NGAYBATDAU5NAM, KHUVUCSONG_ID, BENHVIEN_KCB, BV.TENBENHVIEN FROM TT_TIEPNHAN_SOTHEBHYT ST   LEFT JOIN TM_BENHVIEN BV ON BV.MABENHVIEN = ST.BENHVIEN_KCB WHERE TIEPNHAN_ID = @TIEPNHAN_ID ORDER BY SOBHYT_HUONG_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "SKBNGOAITRU",
    "query": "SELECT DISTINCT KB.KHAMBENH_ID ,FORMAT(KB.THOIGIANKHAM, 'dd/MM/yyyy HH:mm:ss') THOIGIANKHAM, tnkh.SOGIAYHENTK,FORMAT(tnkh.THOIGIANTAIKHAM, 'dd/MM/yyyy HH:mm:ss') AS NGAYTAIKHAM,tn.TENNHANVIEN as THUTRUONG FROM TT_NGOAITRU_TOATHUOC TT   INNER JOIN TT_NGOAITRU_KHAMBENH KB   ON TT.KHAMBENH_ID = KB.KHAMBENH_ID LEFT JOIN TT_NGOAITRU_KHAMBENH_HENTK tnkh ON KB.KHAMBENH_ID = tnkh.KHAMBENH_ID LEFT join TM_NHANVIEN tn ON tn.NHANVIEN_ID = tnkh.THUTRUONG_ID WHERE TT.TIEPNHAN_ID = @TIEPNHAN_ID AND (@THOIGIANKHAM IS NULL OR CONVERT(DATE, KB.THOIGIANKHAM) = CONVERT(DATE, @THOIGIANKHAM)) ORDER BY THOIGIANKHAM",
    "param": {
      "TIEPNHAN_ID": "",
      "THOIGIANKHAM": ""
    }
  },
  {
    "code": "THUOCNGOAITRU",
    "query": "SELECT KBTT.KHAMBENH_TOATHUOC_ID, KBTT.KHAMBENH_ID,FORMAT(KBTT.THOIGIANTOATHUOC, 'dd/MM/yyyy HH:mm:ss') THOIGIANTOATHUOC, TT.TOATHUOC_ID, CAST(TT.SOLUONG as DECIMAL(10, 3)) AS SOLUONG,D.DUOC_ID,D.MADUOC ,D.TENDUOCDAYDU, KBTT.LOAITOATHUOC, KBTT.TRANGTHAI, KBTT.HUYTOATHUOC,KBTT.CHUNGTUPHATTHUOC_ID FROM TT_NGOAITRU_KHAMBENH_TOATHUOC KBTT INNER JOIN TT_NGOAITRU_TOATHUOC TT ON KBTT.KHAMBENH_TOATHUOC_ID = TT.KHAMBENH_TOATHUOC_ID AND TT.TIEPNHAN_ID = @TIEPNHAN_ID INNER JOIN TM_DUOC D ON D.DUOC_ID = TT.DUOC_ID WHERE KBTT.KHAMBENH_ID = @KHAMBENH_ID",
    "param": {
      "TIEPNHAN_ID": "",
      "KHAMBENH_ID": ""
    }
  },
  {
    "code": "SCHUNGTUNT",
    "query": "SELECT ld.DICTIONARY_NAME as LOAI,tdc.MUCDICHCHUNGTU_CODE as MA, CT.SOLONHAP_ID, FORMAT(tdc.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss') as NGAYCHUNGTU,tdc.MACHUNGTU,tdc.CHUNGTU_ID, CT.CHUNGTUCHITIET_ID, tdc.KHOXUAT_ID as KX_ID,kx.TENKHO AS KHOXUAT, tdc.KHONHAP_ID as KN_ID,kn.TENKHO AS KHONHAP, CAST(CT.SOLUONGYEUCAU as DECIMAL(10, 3)) as SOLUONGYEUCAU, CAST(CT.SOLUONGDAXUAT as DECIMAL(10, 3)) as SOLUONGDAXUAT, tdc.DIENGIAINGHIEPVUPHATSINH FROM TT_DUOC_CHUNGTU_CHITIET CT   INNER join TT_DUOC_CHUNGTU tdc   ON CT.CHUNGTU_ID = tdc.CHUNGTU_ID INNER join LST_DICTIONARY ld   on ld.DICTIONARY_ID = tdc.MUCDICHCHUNGTU_ID AND ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' LEFT JOIN TM_KHODUOC kn ON kn.KHODUOC_ID = tdc.KHONHAP_ID LEFT JOIN TM_KHODUOC kx ON kx.KHODUOC_ID = tdc.KHOXUAT_ID where CT.TOATHUOCNGOAITRU_ID =  @TOATHUOC_ID ORDER BY tdc.CHUNGTU_ID",
    "param": {
      "TOATHUOC_ID": ""
    }
  },
  {
    "code": "THUOCPTTT",
    "query": "SELECT PT.PHAUTHUAT_ID,PT.SOPHIEUPHAUTHUAT, VTYT.PHAUTHUAT_VTYT_ID,D.TENDUOCDAYDU,D.DUOC_ID, isnull(td.TENDICHVU,'NULL') as TENDICHVU, CAST(VTYT.SOLUONG as DECIMAL(10, 3)) AS SOLUONG,VTYT.TINHTIEN, VTYT.BNTUCHITRA, VTYT.DUTRUCHITIET_VTYT_ID,VTYT.CHUNGTUTONGHOP_ID,KT.TENKHO AS KHOTAO,KP.TENKHO AS KHOPHAT FROM TT_PHAUTHUAT PT   INNER JOIN TT_PHAUTHUAT_VTYT VTYT   ON PT.PHAUTHUAT_ID = VTYT.PHAUTHUAT_ID INNER JOIN TM_DUOC  D ON D.DUOC_ID = VTYT.DUOC_ID INNER JOIN TM_LOAIDUOC tl ON D.LOAIDUOC_ID = tl.LOAIDUOC_ID left JOIN TM_DICHVU td ON VTYT.DICHVU_ID = td.DICHVU_ID \tLEFT join TM_KHODUOC KT on KT.KHODUOC_ID = VTYT.KHOTAO_ID \tLEFT join TM_KHODUOC KP ON KP.KHODUOC_ID = VTYT.KHOPHAT_ID WHERE TIEPNHAN_ID  =@TIEPNHAN_ID AND ((@THUOC = 1 AND tl.LOAIVATTU_ID = 'T') OR (@VTYT = 1 AND tl.LOAIVATTU_ID = 'V'))",
    "param": {
      "TIEPNHAN_ID": "",
      "THOIGIANKHAM": "",
      "THUOC": "",
      "VTYT": ""
    }
  },
  {
    "code": "SCHUNGTUPTTT",
    "query": "SELECT LOAI = CASE WHEN PL.COSO = 0 THEN N'Lĩnh người bệnh' WHEN PL.COSO = 1 THEN N'Lĩnh bù cơ số' WHEN PL.COSO = 2 THEN N'Lĩnh nội bộ' ELSE 'Phiếu Lĩnh' END ,MA = 'PL' ,CT.SOLONHAP_ID ,FORMAT(PL.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss') AS NGAYCHUNGTU ,PL.MACHUNGTU ,PL.CHUNGTU_ID ,CT.CHUNGTUCHITIET_ID ,PL.KHOXUAT_ID AS KX_ID ,kx.TENKHO AS KHOXUAT ,PL.KHONHAP_ID AS KN_ID ,kn.TENKHO AS KHONHAP ,CAST(CT.SOLUONGYEUCAU AS DECIMAL(10, 3)) AS SOLUONGYEUCAU ,CAST(CT.SOLUONGDAXUAT AS DECIMAL(10, 3)) AS SOLUONGDAXUAT ,'' AS DIENGIAINGHIEPVUPHATSINH ,PL.CHUNGTULIENQUAN_ID FROM TT_DUOC_PHIEULINH_CHITIET CT INNER JOIN TT_DUOC_PHIEULINH PL ON PL.CHUNGTU_ID = CT.CHUNGTU_ID LEFT JOIN TM_KHODUOC kn ON kn.KHODUOC_ID = PL.KHONHAP_ID LEFT JOIN TM_KHODUOC kx ON kx.KHODUOC_ID = PL.KHOXUAT_ID WHERE CT.TOATHUOCNOITRU_ID = @PHAUTHUAT_VTYT_ID AND CT.REF_TABLE = 'TT_PHAUTHUAT_VTYT' UNION all SELECT ld.DICTIONARY_NAME as LOAI,tdc.MUCDICHCHUNGTU_CODE as MA, CT.SOLONHAP_ID, FORMAT(tdc.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss') as NGAYCHUNGTU,tdc.MACHUNGTU,tdc.CHUNGTU_ID, CT.CHUNGTUCHITIET_ID, tdc.KHOXUAT_ID as KX_ID,kx.TENKHO AS KHOXUAT, tdc.KHONHAP_ID as KN_ID,kn.TENKHO AS KHONHAP, CAST(CT.SOLUONGYEUCAU as DECIMAL(10, 3)) as SOLUONGYEUCAU, CAST(CT.SOLUONGDAXUAT as DECIMAL(10, 3)) as SOLUONGDAXUAT, tdc.DIENGIAINGHIEPVUPHATSINH, tdc.CHUNGTULIENQUAN_ID FROM TT_DUOC_CHUNGTU_CHITIET CT   INNER join TT_DUOC_CHUNGTU tdc   ON CT.CHUNGTU_ID = tdc.CHUNGTU_ID INNER join LST_DICTIONARY ld   on ld.DICTIONARY_ID = tdc.MUCDICHCHUNGTU_ID AND ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' LEFT JOIN TM_KHODUOC kn ON kn.KHODUOC_ID = tdc.KHONHAP_ID LEFT JOIN TM_KHODUOC kx ON kx.KHODUOC_ID = tdc.KHOXUAT_ID where CT.PHAUTHUAT_VTYT_ID =  @PHAUTHUAT_VTYT_ID",
    "param": {
      "PHAUTHUAT_VTYT_ID": ""
    }
  },
  {
    "code": "THUOCCLS",
    "query": "SELECT VTYT.CLSKETQUA_VTYT_ID,VTYT.DVYEUCAU_ID,D.TENDUOCDAYDU ,CAST(VTYT.SOLUONG as DECIMAL(10, 3)) AS SOLUONG ,DV.TENDICHVU, VTYT.TINHTIEN, vtyt.BHYTDONGTIEN FROM TT_CLSKETQUA_VTYT VTYT   INNER JOIN TT_DVYEUCAU YC    ON VTYT.DVYEUCAU_ID = YC.DVYEUCAU_ID INNER JOIN TM_DUOC D   ON VTYT.DUOC_ID = D.DUOC_ID INNER JOIN TM_DICHVU DV   ON DV.DICHVU_ID = YC.DICHVU_ID WHERE YC.TIEPNHAN_ID =@TIEPNHAN_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "SCHUNGTUCLS",
    "query": "SELECT ld.DICTIONARY_NAME as LOAI,tdc.MUCDICHCHUNGTU_CODE as MA, CT.SOLONHAP_ID, FORMAT(tdc.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss') as NGAYCHUNGTU,tdc.MACHUNGTU,tdc.CHUNGTU_ID, CT.CHUNGTUCHITIET_ID, tdc.KHOXUAT_ID as KX_ID,kx.TENKHO AS KHOXUAT, tdc.KHONHAP_ID as KN_ID,kn.TENKHO AS KHONHAP, CAST(CT.SOLUONGYEUCAU as DECIMAL(10, 3)) as SOLUONGYEUCAU, CAST(CT.SOLUONGDAXUAT as DECIMAL(10, 3)) as SOLUONGDAXUAT, tdc.DIENGIAINGHIEPVUPHATSINH FROM TT_DUOC_CHUNGTU_CHITIET CT   INNER join TT_DUOC_CHUNGTU tdc   ON CT.CHUNGTU_ID = tdc.CHUNGTU_ID INNER join LST_DICTIONARY ld   on ld.DICTIONARY_ID = tdc.MUCDICHCHUNGTU_ID AND ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' LEFT JOIN TM_KHODUOC kn ON kn.KHODUOC_ID = tdc.KHONHAP_ID LEFT JOIN TM_KHODUOC kx ON kx.KHODUOC_ID = tdc.KHOXUAT_ID where CT.CLSKETQUA_VTYT_ID =  @CLSKETQUA_VTYT_ID ORDER BY tdc.CHUNGTU_ID",
    "param": {
      "CLSKETQUA_VTYT_ID": ""
    }
  },
  {
    "code": "UPDSAIKHO",
    "query": "update kb set KHODUOC_ID = KHOPHAT_ID from  TT_NOITRU_KHAMBENH   kb inner join TT_NOITRU_BENHAN   ba on ba.BENHAN_ID = kb.BENHAN_ID and ba.THOIGIANRAVIEN is null inner join TT_NOITRU_TOATHUOC   tt on kb.KHAMBENH_ID = tt.KHAMBENH_ID and SOLUONGTHUCLINH > 0 and kb.RAVIEN ='0' and kb.ISYLENHVTYT ='0' and HUYTOATHUOC ='0' inner join TM_KHODUOC   k0 on k0.KHODUOC_ID = kb.KHODUOC_ID inner join TM_KHODUOC   k1 on k1.KHODUOC_ID = tt.KHOPHAT_ID inner join TM_KHODUOC   k2 on k2.KHODUOC_ID = tt.KHOTAO_ID inner join LST_DICTIONARY   d0 on d0.DICTIONARY_ID = k0.LOAIKHO_ID and d0.DICTIONARY_CODE = 'CoSo' inner join LST_DICTIONARY   d1 on d1.DICTIONARY_ID = k1.LOAIKHO_ID and d1.DICTIONARY_CODE = 'KhoLe' inner join LST_DICTIONARY   d2 on d2.DICTIONARY_ID = k2.LOAIKHO_ID and d2.DICTIONARY_CODE = 'KhoBenhNhan' WHERE tt.TIEPNHAN_ID = @TIEPNHAN_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "GETBNMONGO",
    "query": "select top 1 a.MAYTE as _id,a.BENHNHAN_ID,a.MAYTE,null FID,a.HO,a.TEN,a.TENBENHNHAN,a.GIOITINH as GIOITINH_ID,a.NGAYSINH,a.NAMSINH,a.SODIENTHOAI,a.DIACHILIENLAC,a.DIACHITHUONGTRU, a.HINHANH_DAIDIEN,a.TIENSUBENH,a.TIENSUDIUNG,a.TUVONG,a.CMND,a.GIOITINH,a.NGHENGHIEP_ID, gd.DESCRIPTION TENGIOITINH, (CASE WHEN CONVERT(int,ROUND(DATEDIFF(hour,NGAYSINH,GETDATE())/8766.0,0)) >= 16 THEN 'NGUOILON' ELSE 'TREEM' END) DOTUOI,NN.DICTIONARY_NAME NGHENGHIEP,a.DIACHICOQUAN,a.DONVICONGTAC_ID,a.GHICHU,a.SONHA,a.QUANHUYEN_ID,a.XAPHUONG_ID,tn.TIEPNHAN_ID TIEPNHAN_ID,tn.DOITUONG_ID from TT_BENHNHAN A join TM_GENDER GD on GD.ID = a.GIOITINH left join TT_TIEPNHAN TN on TN.BENHNHAN_ID = a.BENHNHAN_ID left join LST_DICTIONARY NN on NN.DICTIONARY_ID = a.NGHENGHIEP_ID where  a.MAYTE = @MAYTE order by tn.TIEPNHAN_ID desc FOR JSON  path,INCLUDE_NULL_VALUES",
    "param": {
      "MAYTE": ""
    }
  },
  {
    "code": "SGIUONG",
    "query": "SELECT tnl.LUUTRUCHITIET_ID, LT.LUUTRU_ID,tp.TENPHONGBAN, tp1.TENPHONGBAN AS PHONG, tg.MAGIUONG, FORMAT(tnl.THOIGIANVAO, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANVAO,  FORMAT(tnl.THOIGIANRA, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANRA  ,CONCAT(NT.TENNHANVIEN,' - ', NT.MA_BAC_SI) as NGUOICAP, tnl.SONGAY, tnl.SONGAYBHYT, tnl.LOAIGIUONGBENH_ID, td.TENDICHVU, tnl.DICHVU_CONGCHAMSOC_ID,tnl.LOAIGIA_ID, tnl.BAOPHONG, tnl.BAOGIUONG FROM TT_NOITRU_BENHAN BA INNER JOIN TT_NOITRU_LUUTRU LT ON BA.BENHAN_ID = LT.BENHAN_ID INNER JOIN TT_NOITRU_LUUTRUCHITIET tnl ON LT.LUUTRU_ID = tnl.LUUTRU_ID LEFT JOIN TM_PHONGBAN tp ON tnl.PHONGBAN_ID = tp.PHONGBAN_ID LEFT JOIN TM_PHONGBAN tp1 ON tnl.PHONGBENH_ID = tp1.PHONGBAN_ID LEFT JOIN TM_GIUONGBENH tg ON tnl.GIUONGBENH_ID = tg.GIUONGBENH_ID LEFT JOIN TM_DICHVU td ON tnl.LOAIGIUONGBENH_ID = td.DICHVU_ID LEFT join TM_NHANVIEN NT on NT.NHANVIEN_ID = tnl.NGUOITAO_ID WHERE BA.BENHAN_ID = @BENHAN_ID ORDER BY tnl.THOIGIANVAO",
    "param": {
      "BENHAN_ID": ""
    }
  },
  {
    "code": "SXNBHYT",
    "query": "SELECT tx.XACNHANCHIPHI_ID AS ID, tx.XACNHANCHIPHICHITIET_ID AS XNCT_ID,XN.LOAI,FORMAT(XN.THOIGIANXACNHAN,'dd/MM/yyyy HH:mm:ss') AS TGXACNHAN ,tx.VIENPHI_ID,tx.IDREF, tx.NOIDUNG_ID, tx.NOIDUNG, cast(tx.SOLUONG as DECIMAL(10, 3)) AS SL, tx.DONGIAHOTRO, tx.DONGIAHOTROCHITRA, tv.REF_TABLE FROM TT_XACNHANCHIPHI XN INNER JOIN TT_XACNHANCHIPHICHITIET tx ON XN.XACNHANCHIPHI_ID = tx.XACNHANCHIPHI_ID INNER JOIN TT_VIENPHI tv ON tx.VIENPHI_ID = tv.VIENPHI_ID where XN.TIEPNHAN_ID = @TIEPNHAN_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "sDIC",
    "query": "SELECT top 200 DICTIONARY_ID ,DICTIONARY_TYPE_ID ,DICTIONARY_TYPE_CODE ,DICTIONARY_CODE ,DICTIONARY_NAME ,CAST(ENABLED as bit) as ENABLED FROM LST_DICTIONARY where DICTIONARY_TYPE_CODE LIKE '%' + @TEXT + '%' OR DICTIONARY_NAME LIKE '%' + @TEXT + '%' OR cast(DICTIONARY_ID as VARCHAR(250)) = @TEXT",
    "param": {
      "TEXT": ""
    }
  },
  {
    "code": "GETDICHGQ",
    "query": "SELECT DICTIONARY_ID ,DICTIONARY_TYPE_ID ,DICTIONARY_TYPE_CODE ,DICTIONARY_CODE ,DICTIONARY_NAME,CAST(ENABLED as bit) as ENABLED FROM LST_DICTIONARY where DICTIONARY_TYPE_CODE = 'GiaiQuyetKhamBenh' ORDER BY ENABLED DESC,IDX ASC",
    "param": {
      "TEXT": ""
    }
  },
  {
    "code": "GETDICCK",
    "query": "SELECT CHUYENKHOA_ID ,MACHUYENKHOA ,TENCHUYENKHOA ,CAST(TAMNGUNG as bit) as TAMNGUNG,CHUYENKHOA_ID_NOITRU ,CHUYENKHOA_ID_NGOAITRU ,LOAIBENHAN ,MACHUYENKHOAEBS FROM TM_CHUYENKHOA",
    "param": {
      "TEXT": ""
    }
  },
  {
    "code": "GETDICLBA",
    "query": "SELECT LOAIBENHAN_ID ,MALOAIBENHAN ,TENLOAIBENHAN ,CAST(TAMNGUNG as bit) as TAMNGUNG,PROPERTY1 ,PROPERTY2 ,PROPERTY3 FROM TM_LOAIBENHAN",
    "param": {
      "TEXT": ""
    }
  },
  {
    "code": "sHD",
    "query": "SELECT  HOADON_ID, SOHOADON,BENHAN_ID,format(NGAYHOADON,'dd/MM/yyyy HH:mm:ss') AS NGAYHOADON, LOAIHOADON,format(GIATRIHOADON,'N','vi-VN') as GIATRIHOADON,format(GIATRITHUCTHU,'N','vi-VN') as GIATRITHUCTHU, HUYHOADON, HOANTRA, DATHANHTOAN, TRANGTHAI, format(THOIGIAN_DUYET_HUY,'dd/MM/yyyy HH:mm:ss') AS TG_DUYET_HUY, format(THOIGIAN_HUY_HOANTRA,'dd/MM/yyyy HH:mm:ss') AS TG_HUY_HOANTRA, THUTHEM FROM TT_HOADON where TIEPNHAN_ID = @TIEPNHAN_ID ORDER BY HOADON_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "GETKD",
    "query": "SELECT tk.KHODUOC_ID ,tk.MAKHO ,tk.TENKHO ,tk.LOAIKHO_ID ,tk.LOAIDUOC ,tk.PHONGBAN_ID ,CAST(tk.TAMNGUNG AS BIT) as TAMNGUNG FROM TM_KHODUOC tk  where tk.TENKHO LIKE '%' + @TEXT + '%' OR tk.MAKHO LIKE '%' + @TEXT + '%' OR cast(tk.KHODUOC_ID as VARCHAR(250)) = @TEXT",
    "param": {
      "TEXT": ""
    }
  },
  {
    "code": "GETPB",
    "query": "SELECT tp.PHONGBAN_ID ,tp.MAPHONGBAN ,tp.TENPHONGBAN ,tp.LOAIPHONGBAN_ID ,ld.DICTIONARY_NAME AS LOAIPHONGBAN ,tp.CAP ,tp.CAPTREN_ID ,tp.TAMNGUNG ,tp.MAPHONGBANBYT ,tp.IPD_BLOCK_VP ,tp.IPD_BLOCK_BH FROM TM_PHONGBAN tp INNER JOIN LST_DICTIONARY ld ON tp.LOAIPHONGBAN_ID = ld.DICTIONARY_ID AND ld.DICTIONARY_TYPE_CODE = 'LoaiPhongBan' where tp.TENPHONGBAN LIKE '%' + @TEXT + '%' OR tp.MAPHONGBAN LIKE '%' + @TEXT + '%' OR tp.MAPHONGBANBYT LIKE '%' + @TEXT + '%' OR cast(tp.PHONGBAN_ID as VARCHAR(250)) = @TEXT",
    "param": {}
  },
  {
    "code": "GETCACHE",
    "query": "SELECT ID ,DAO_ID ,STATEMENT_ID ,RESULT_VALUE ,RESULT_TEXT ,CONDITIONS ,CAST(ACTIVE AS BIT) AS ACTIVE ,UPDATE_TIME ,TABLE_AFFECT FROM TM_SYS_CACHE where ID LIKE '%' + @TEXT + '%'",
    "param": {
      "TEXT": ""
    }
  },
  {
    "code": "GETAPPSETTING",
    "query": "SELECT tsa.SETTING_ID ,tsa.CODE ,tsa.VALUE ,tsa.DESCRIPTION ,CAST(tsa.LOCKED AS BIT) AS LOCKED ,tsa.TYPE,tsa.BENHVIEN_ID FROM TM_SYS_APPSETTINGS tsa where tsa.CODE LIKE '%' + @TEXT + '%' OR tsa.DESCRIPTION LIKE '%' + @TEXT + '%'",
    "param": {
      "TEXT": ""
    }
  },
  {
    "code": "SDUOC",
    "query": "SELECT TOP 100 DUOC_ID ,MaDuoc ,TenDuocDayDu ,tl.LOAIVATTU_ID ,D.DONVITINH ,D.MAHOATCHAT,D.TENHOATCHAT ,D.BHYT ,D.NHATHUOC ,D.THUOCKELE ,D.DUOCGHINHAN_VTYT ,D.VATNHATHUOC ,CAST(D.TAMNGUNG AS BIT) AS TAMNGUNG FROM TM_DUOC D LEFT join TM_LOAIDUOC tl ON D.LOAIDUOC_ID = tl.LOAIDUOC_ID where D.TENDUOCDAYDU LIKE '%' + @TEXT + '%' OR D.MADUOC = @TEXT OR cast(D.DUOC_ID as VARCHAR(250)) = @TEXT",
    "param": {
      "TEXT": ""
    }
  },
  {
    "code": "SDICHVU",
    "query": "SELECT TOP 100 DV.DICHVU_ID ,tn.TENNHOMDICHVU ,DV.MADICHVU ,DV.TENDICHVU ,DV.HOICHAN ,DV.NORESULT ,DV.BHYT,DV.THONGTUBOYTE,DV.TEN_BHYT ,CAST(DV.TAMNGUNG AS BIT) TAMNGUNG FROM TM_DICHVU DV INNER JOIN TM_NHOMDICHVU tn ON DV.NHOMDICHVU_ID = tn.NHOMDICHVU_ID where DV.TENDICHVU LIKE N'%' + @TEXT + '%' OR cast(DV.DICHVU_ID as VARCHAR(250)) = @TEXT",
    "param": {
      "TEXT": ""
    }
  },
  {
    "code": "DELTHYL",
    "query": "DELETE TT_NOITRU_THUCHIENYLENH WHERE THYL_ID IN ( SELECT max(THYL_ID) FROM TT_NOITRU_THUCHIENYLENH where TOATHUOC_ID in (@SLTTOATHUOC_ID) AND TRANGTHAITHUCHIENYLENH != 'NGUNGSUDUNG' GROUP BY TOATHUOC_ID )",
    "param": {
      "SLTTOATHUOC_ID": ""
    }
  },
  {
    "code": "sTHUOCNGUNG",
    "query": "SELECT CT.TRATHUOC_ID, CT.TRATHUOCCHITIET_ID, TT.SOPHIEU, TT.BENHAN_ID,FORMAT(TT.THOIGIANTRA,'dd/MM/yyyy HH:mm:ss') AS THOIGIANTRA, CT.CHUNGTUTRA_ID,CAST(CT.DAHOANTRA AS BIT) DAHOANTRA, CT.SOLUONG, TT.GHICHU FROM TT_NOITRU_TRATHUOC TT INNER JOIN TT_NOITRU_TRATHUOC_CHITIET CT ON TT.TRATHUOC_ID = CT.TRATHUOC_ID WHERE CT.TOATHUOC_ID = @TOATHUOC_ID",
    "param": {
      "TOATHUOC_ID": ""
    }
  },
  {
    "code": "GET_KHAMCK",
    "query": "SELECT KB.KHAMBENH_ID, FORMAT(KB.THOIGIANKHAM,'dd/MM/yyyy HH:mm:ss') AS THOIGIANKHAM  FROM TT_DVYEUCAU YC INNER JOIN TT_NOITRU_KHAMBENH KB ON KB.KHAMBENH_ID = YC.KHAMBENH_NOITRU_ID AND KB.KHAMCHUYENKHOA = '1' WHERE YC.DVYEUCAU_ID = @DVYEUCAU_ID AND YC.TIEPNHAN_ID = @TIEPNHAN_ID AND YC.KHAMCHUYENKHOA = '1'",
    "param": {
      "TIEPNHAN_ID": "",
      "DVYEUCAU_ID": ""
    }
  },
  {
    "code": "GETSOLO",
    "query": "SELECT a.SOLONHAP_ID,a.SOLONHAP,a.SOLOSANPHAM,a.DUOC_ID,td.TENDUOCDAYDU,tdsg.DONGIABAN,a.DONGIATHAU,cast(a.BHYT AS bit) AS BHYT, a.HANHUONGBHYT,a.HOSOTHAU_CHITIET_ID ,tdt.KHODUOC_ID,tk.TENKHO,tdt.SOLUONG FROM TT_DUOC_CHUNGTU_SOLONHAP a INNER JOIN TT_DUOC_SOLONHAP_GIABAN tdsg ON a.SOLONHAP_ID = tdsg.SOLONHAP_ID INNER JOIN TM_DUOC td ON a.DUOC_ID = td.DUOC_ID LEFT join TT_DUOC_TONKHO tdt on a.SOLONHAP_ID = tdt.SOLONHAP_ID LEFT join TM_KHODUOC tk on tdt.KHODUOC_ID = tk.KHODUOC_ID where a.SOLONHAP_ID = @SOLONHAP OR a.SOLONHAP = @SOLONHAP",
    "param": {
      "SOLONHAP": ""
    }
  },
  {
    "code": "GETCTBYMA0",
    "query": "SELECT CT.CHUNGTU_ID,CTCT.CHUNGTUCHITIET_ID, CONCAT(CT.MACHUNGTU,' - ',FORMAT(CT.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss'), ' - ',ld.DICTIONARY_NAME,' - ',CT.DIENGIAINGHIEPVUPHATSINH) as CHUNGTU,CT.SOCHUNGTUGOC ,CT.CHUNGTULIENQUAN_ID AS CTLQ , CTCT.SOLONHAP_ID,tdcs.SOLONHAP,td.MADUOC ,td.TENDUOCDAYDU ,CTCT.SOLUONGYEUCAU AS SLYC ,CTCT.SOLUONGTHUCTE AS SLTT ,CTCT.SOLUONGDAXUAT AS SLXUAT ,tk1.TENKHO AS KHONHAP ,tk.TENKHO AS KHOXUAT ,COALESCE(CTCT.TOATHUOCNOITRU_ID, CTCT.TOATHUOCNGOAITRU_ID, CTCT.PHAUTHUAT_VTYT_ID, CTCT.CLSKETQUA_VTYT_ID) AS REF_ID ,CASE WHEN CTCT.TOATHUOCNOITRU_ID IS NOT NULL THEN 'TT_NOITRU_TOATHUOC' WHEN CTCT.TOATHUOCNGOAITRU_ID IS NOT NULL THEN 'TT_NGOAITRU_TOATHUOC' WHEN CTCT.PHAUTHUAT_VTYT_ID IS NOT NULL THEN 'TT_PHAUTHUAT_VTYT' WHEN CTCT.CLSKETQUA_VTYT_ID IS NOT NULL THEN 'TT_CLSKETQUA_VTYT' ELSE '' END AS REF_TABLE FROM TT_DUOC_CHUNGTU CT INNER JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID INNER JOIN LST_DICTIONARY ld ON CT.MUCDICHCHUNGTU_ID = ld.DICTIONARY_ID AND ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' INNER JOIN TM_DUOC td ON CTCT.DUOC_ID = td.DUOC_ID LEFT JOIN TM_KHODUOC tk ON CT.KHOXUAT_ID = tk.KHODUOC_ID LEFT JOIN TM_KHODUOC tk1 ON CT.KHONHAP_ID = tk1.KHODUOC_ID LEFT join TT_DUOC_CHUNGTU_SOLONHAP tdcs ON CTCT.SOLONHAP_ID = tdcs.SOLONHAP_ID WHERE CT.MACHUNGTU = @MACHUNGTU",
    "param": {
      "MACHUNGTU": ""
    }
  },
  {
    "code": "GETCTBYMA1",
    "query": "SELECT '' as CHUNGTU,CT.CHUNGTU_ID, CT.MACHUNGTU,CT.SOCHUNGTUGOC,CT.CHUNGTULIENQUAN_ID as CTLQ,FORMAT(CT.NGAYCHUNGTU,'dd/MM/yyyy HH:mm:ss') AS NGAYCHUNGTU, td.MADUOC,td.TENDUOCDAYDU, CTCT.SOLUONGYEUCAU AS SLYC, CTCT.SOLUONGTHUCTE AS SLTT, CTCT.SOLUONGDAXUAT AS SLXUAT, tk1.TENKHO as KHONHAP, tk.TENKHO as KHOXUAT,ld.DICTIONARY_NAME as LOAI, CTCT.REF_TABLE as REF_TABLE, CTCT.BENHNHAN FROM TT_DUOC_PHIEULINH  CT INNER JOIN TT_DUOC_PHIEULINH_CHITIET CTCT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID INNER JOIN TM_DUOC td ON CTCT.DUOC_ID = td.DUOC_ID LEFT JOIN LST_DICTIONARY ld ON CT.LOAIPHIEULINH = ld.DICTIONARY_CODE and ld.DICTIONARY_TYPE_CODE = 'LoaiPhieuLinh' LEFT JOIN TM_KHODUOC tk ON CT.KHOXUAT_ID = tk.KHODUOC_ID LEFT JOIN TM_KHODUOC tk1 ON CT.KHONHAP_ID = tk1.KHODUOC_ID where CT.MACHUNGTU = @MACHUNGTU",
    "param": {
      "MACHUNGTU": ""
    }
  },
  {
    "code": "GETCTBYMA2",
    "query": "SELECT '' as CHUNGTU,CT.CHUNGTU_ID, CT.MACHUNGTU,CT.SOCHUNGTUGOC,CT.CHUNGTULIENQUAN_ID as CTLQ,FORMAT(CT.NGAYCHUNGTU,'dd/MM/yyyy HH:mm:ss') AS NGAYCHUNGTU, CT.MUCDICHCHUNGTU_CODE AS CODE,ld.DICTIONARY_NAME AS LOAI ,td.MADUOC,td.TENDUOCDAYDU, CTCT.SOLUONGTHUCTE AS SLTT, tk1.TENKHO as KHONHAP, tk.TENKHO as KHOXUAT,CT.DIENGIAI, CT.DIENGIAINGHIEPVUPHATSINH FROM TT_DUOC_KYGUI_CHUNGTU CT INNER JOIN TT_DUOC_KYGUI_CHUNGTU_CHITIET CTCT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID INNER JOIN LST_DICTIONARY ld ON CT.MUCDICHCHUNGTU_ID = ld.DICTIONARY_ID and ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' INNER JOIN TM_DUOC td ON CTCT.DUOC_ID = td.DUOC_ID LEFT JOIN TM_KHODUOC tk ON CT.KHOXUAT_ID = tk.KHODUOC_ID LEFT JOIN TM_KHODUOC tk1 ON CT.KHONHAP_ID = tk1.KHODUOC_ID where CT.MACHUNGTU = @MACHUNGTU",
    "param": {
      "MACHUNGTU": ""
    }
  },
  {
    "code": "GETCTBYMA3",
    "query": "SELECT '' as CHUNGTU,CT.CHUNGTU_ID, CT.MACHUNGTU,FORMAT(CT.NGAYGIOLAPCHUNGTU,'dd/MM/yyyy HH:mm:ss') AS NGAYCHUNGTU,CT.STATE_CODE,CT.STATE_NAME,CT.TENNHACUNGCAP, CTCT.MAHANGHOA,CTCT.TENHANGHOA,CTCT.SOLUONGYEUCAU,CTCT.SOLUONGDANHAP,CTCT.DUTRU_ID,CTCT.DUTRUCHITIET_ID,CTCT.SOQUYETDINH FROM TT_PUR_CHUNGTU CT INNER JOIN TT_PUR_CHUNGTUCHITIET CTCT ON CT.CHUNGTU_ID = CTCT.CHUNGTU_ID where CT.MACHUNGTU = @MACHUNGTU",
    "param": {
      "MACHUNGTU": ""
    }
  },
  {
    "code": "GETCTBYMA4",
    "query": "SELECT CT.CHUNGTU_ID,CT.MACHUNGTU,CT.MACHUNGTUREF AS PO ,CTCT.CHUNGTUCHITIET_ID ,CONCAT(FORMAT(CT.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss'), ' - ', CT.DIENGIAINGHIEPVUPHATSINH) AS CHUNGTU ,td.MADUOC ,td.TENDUOCDAYDU ,CTCT.SOLUONGTHUCTE AS SLTT ,tk1.TENKHO AS KHONHAP FROM TT_DUOC_CHUNGTU_SOLONHAP SL INNER JOIN TT_DUOC_CHUNGTU_CHITIET CTCT ON SL.SOLONHAP_ID = CTCT.SOLONHAP_ID INNER JOIN TT_DUOC_CHUNGTU CT ON CTCT.CHUNGTU_ID = CT.CHUNGTU_ID INNER JOIN TM_DUOC td ON CTCT.DUOC_ID = td.DUOC_ID LEFT JOIN TM_KHODUOC tk1 ON CT.KHONHAP_ID = tk1.KHODUOC_ID where CT.MUCDICHCHUNGTU_CODE = 'N01' AND ( SL.SOLONHAP_ID =@SOLONHAP or SL.SOLONHAP = cast(@SOLONHAP AS NVARCHAR(30) ))",
    "param": {
      "SOLONHAP": ""
    }
  },
  {
    "code": "sDDT",
    "query": "SELECT DOTDIEUTRI_ID ,MADOTDIEUTRI ,TENDOTDIEUTRI ,FORMAT(THOIGIANTUNGAY,'dd/MM/yyyy HH:mm:ss') AS TUNGAY ,FORMAT(THOIGIANDENNGAY,'dd/MM/yyyy HH:mm:ss') AS TGNDENNGAY ,TRANGTHAI ,DAXACNHAN_BHYT ,tp.TENPHONGBAN ,tn.TENNHANVIEN AS BACSIDIEUTRI FROM TT_NOITRU_DOTDIEUTRI a LEFT JOIN TM_NHANVIEN tn on a.BACSYDIEUTRI_ID = tn.NHANVIEN_ID LEFT join TM_PHONGBAN tp on a.KHOADIEUTRI_ID = tp.PHONGBAN_ID WHERE a.BENHAN_ID = @BENHAN_ID",
    "param": {
      "BENHAN_ID": ""
    }
  },
  {
    "code": "SMIENGIAM",
    "query": "SELECT a.MIENGIAM_BHTN_ID AS MIENGIAM_ID, tmc.MIENGIAMCHITIET_ID,tmc.VIENPHI_ID,a.BENHAN_ID ,COALESCE(td.DICHVU_ID,td1.DUOC_ID,tnl.LOAIGIUONGBENH_ID) AS NOIDUNG_ID ,CASE WHEN td.DICHVU_ID is NOT NULL THEN td.TENDICHVU WHEN td1.DUOC_ID is NOT NULL THEN td1.TENDUOCDAYDU WHEN tnl.LOAIGIUONGBENH_ID is NOT NULL THEN td2.TENDICHVU ELSE '' END AS NOIDUNG ,concat(tmc.REF_TABLE,' - ',a.SOPHIEUBHTN,' - ', tc.TENCONGTY ) AS LOAI ,cast(tmc.TYLEMIENGIAM AS INT) TYLE,tmc.GIATRIMIENGIAM,tmc.GIATRISAUMIENGIAM,a.NGUOIDUYET_ID,a.NGAYDUYET,a.TINHTRANG ,tv.REF_ID,tv.REF_TABLE FROM TT_MIENGIAM_BHTN a INNER JOIN TT_MIENGIAM_CHITIET tmc on a.MIENGIAM_BHTN_ID = tmc.MIENGIAM_ID and tmc.REF_TABLE = 'TT_MIENGIAM_BHTN' INNER JOIN (SELECT VIENPHI_ID, DUOC_ID,DICHVU_ID,REF_ID,REF_TABLE FROM\tTT_VIENPHI WHERE TIEPNHAN_ID = @TIEPNHAN_ID) tv on tmc.VIENPHI_ID = tv.VIENPHI_ID LEFT join TM_DICHVU td on td.DICHVU_ID = tv.DICHVU_ID LEFT join TM_DUOC td1 on td1.DUOC_ID = tv.DUOC_ID LEFT join TT_NOITRU_LUUTRUCHITIET tnl on tv.REF_ID = tnl.LUUTRUCHITIET_ID and tv.REF_TABLE = 'TT_NOITRU_LUUTRUCHITIET' LEFT join TM_DICHVU td2 ON tnl.LOAIGIUONGBENH_ID = td2.DICHVU_ID \tLEFT join TM_CONGTYBAOHIEM tc on a.CONGTYBHTN_ID = tc.CONGTY_ID where TIEPNHAN_ID = @TIEPNHAN_ID UNION ALL SELECT a.MIENGIAM_ID, tmc.MIENGIAMCHITIET_ID,tmc.VIENPHI_ID,a.BENHAN_ID ,COALESCE(td.DICHVU_ID,td1.DUOC_ID,tnl.LOAIGIUONGBENH_ID) AS NOIDUNG_ID ,CASE WHEN td.DICHVU_ID is NOT NULL THEN td.TENDICHVU WHEN td1.DUOC_ID is NOT NULL THEN td1.TENDUOCDAYDU WHEN tnl.LOAIGIUONGBENH_ID is NOT NULL THEN td2.TENDICHVU ELSE '' END AS NOIDUNG ,concat(tmc.REF_TABLE,' - ',a.SOPHIEUMIENGIAM,' - MÃ: ',a.MAMIENGIAM ) AS LOAI ,cast(tmc.TYLEMIENGIAM AS INT) TYLE,tmc.GIATRIMIENGIAM,tmc.GIATRISAUMIENGIAM,a.NGUOIDUYET_ID,a.NGAYDUYET,a.TINHTRANG ,tv.REF_ID,tv.REF_TABLE FROM TT_MIENGIAM a INNER JOIN TT_MIENGIAM_CHITIET tmc on a.MIENGIAM_ID = tmc.MIENGIAM_ID and tmc.REF_TABLE = 'TT_MIENGIAM' LEFT JOIN (SELECT VIENPHI_ID, DUOC_ID,DICHVU_ID,REF_ID,REF_TABLE FROM\tTT_VIENPHI WHERE TIEPNHAN_ID = @TIEPNHAN_ID) tv on tmc.VIENPHI_ID = tv.VIENPHI_ID LEFT join TM_DICHVU td on td.DICHVU_ID = tv.DICHVU_ID LEFT join TM_DUOC td1 on td1.DUOC_ID = tv.DUOC_ID LEFT join TT_NOITRU_LUUTRUCHITIET tnl on tv.REF_ID = tnl.LUUTRUCHITIET_ID and tv.REF_TABLE = 'TT_NOITRU_LUUTRUCHITIET' LEFT join TM_DICHVU td2 ON tnl.LOAIGIUONGBENH_ID = td2.DICHVU_ID where TIEPNHAN_ID = @TIEPNHAN_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "GETSLTONKHO",
    "query": "DECLARE @DUOC_ID INT  if(ISNUMERIC(@MADUOC) =1) BEGIN SET @DUOC_ID = cast(@MADUOC AS INT) END ELSE BEGIN SET @DUOC_ID = (SELECT top 1 DUOC_ID FROM TM_DUOC where MADUOC = @MADUOC) END SELECT tdk.TENKHO,KD.DUOC_ID,td.MADUOC,td.TENDUOCDAYDU ,KD.SOLUONG,SLO.SOLONHAP_ID,SLO.SOLONHAP,SLO.SOLOSANPHAM,SLO.DONGIAMUA,tdsg.DONGIABAN,SLO.DONGIAVON,SLO.DONGIATHAU,SLO.BHYT,SLO.HANHUONGBHYT,SLO.HOSOTHAU_CHITIET_ID FROM TT_DUOC_TONKHO KD INNER JOIN TM_KHODUOC tdk on KD.KHODUOC_ID = tdk.KHODUOC_ID INNER JOIN TM_DUOC td on KD.DUOC_ID = td.DUOC_ID INNER JOIN TT_DUOC_CHUNGTU_SOLONHAP SLO ON SLO.SOLONHAP_ID = KD.SOLONHAP_ID INNER JOIN TT_DUOC_SOLONHAP_GIABAN tdsg ON SLO.SOLONHAP_ID = tdsg.SOLONHAP_ID where (@DUOC_ID IS NULL OR td.DUOC_ID = @DUOC_ID) AND (KD.KHODUOC_ID = @KHODUOC_ID OR @KHODUOC_ID is null)",
    "param": {
      "BENHAN_ID": ""
    }
  },
  {
    "code": "TIMTHUOCLECH",
    "query": "DECLARE @DUOC_ID INT  if(ISNUMERIC(@MADUOC) =1) BEGIN SET @DUOC_ID = cast(@MADUOC AS INT) END ELSE BEGIN SET @DUOC_ID = (SELECT top 1 DUOC_ID FROM TM_DUOC where MADUOC = @MADUOC) END SELECT * FROM(SELECT a.TOATHUOCNOITRU_ID, MUCDICHCHUNGTU_CODE, SUM(a.SOLUONGDAXUAT) soluong FROM TT_DUOC_CHUNGTU_CHITIET a          JOIN TT_DUOC_CHUNGTU b ON a.CHUNGTU_ID=b.CHUNGTU_ID     WHERE(SOLONHAP_ID=@SOLONHAP_ID OR ISNULL(@SOLONHAP_ID, '')='')AND DUOC_ID=@DUOC_ID AND MUCDICHCHUNGTU_CODE IN ('X13')AND(KHOXUAT_ID=@KHOXUAT_ID)    GROUP BY a.TOATHUOCNOITRU_ID, MUCDICHCHUNGTU_CODE) x    LEFT JOIN(SELECT a.TOATHUOCNOITRU_ID, MUCDICHCHUNGTU_CODE, SUM(a.SOLUONGDAXUAT) soluong              FROM TT_DUOC_CHUNGTU_CHITIET a                   JOIN TT_DUOC_CHUNGTU b ON a.CHUNGTU_ID=b.CHUNGTU_ID              WHERE(SOLONHAP_ID=@SOLONHAP_ID OR ISNULL(@SOLONHAP_ID, '')='')AND DUOC_ID=@DUOC_ID AND MUCDICHCHUNGTU_CODE IN ('N05')AND(KHONHAP_ID=@KHOXUAT_ID)              GROUP BY a.TOATHUOCNOITRU_ID, MUCDICHCHUNGTU_CODE) n ON x.TOATHUOCNOITRU_ID=n.TOATHUOCNOITRU_ID    LEFT JOIN(SELECT a.TOATHUOCNOITRU_ID, MUCDICHCHUNGTU_CODE, SUM(a.SOLUONGTHUCTE) soluong              FROM TT_DUOC_CHUNGTU_CHITIET a                   JOIN TT_DUOC_CHUNGTU b ON a.CHUNGTU_ID=b.CHUNGTU_ID              WHERE(SOLONHAP_ID=@SOLONHAP_ID OR ISNULL(@SOLONHAP_ID, '')='')AND DUOC_ID=@DUOC_ID AND MUCDICHCHUNGTU_CODE IN ('N10')AND(b.KHOXUAT_ID=@KHOXUAT_ID)              GROUP BY a.TOATHUOCNOITRU_ID, MUCDICHCHUNGTU_CODE) t ON t.TOATHUOCNOITRU_ID=n.TOATHUOCNOITRU_ID",
    "param": {
      "MADUOC": "",
      "KHOXUAT_ID": ""
    }
  },
  {
    "code": "sTHUOCBYCT",
    "query": "SELECT CONCAT(tb.MAYTE,' - ',tb.TENBENHNHAN,' - ',KB.KHAMBENH_ID,N' - Thời gian YLệnh: ',format(KB.THOIGIANBATDAU,'dd/MM/yyyy HH:mm:ss')) AS BENHNHAN, CT.LOAI,td.TENDUOCDAYDU as TENDUOC,CT.MA ,CT.SOLONHAP_ID ,CT.NGAYCHUNGTU ,CT.MACHUNGTU ,CT.CHUNGTU_ID ,CT.CHUNGTUCHITIET_ID ,CT.SOLUONGYEUCAU ,CT.SOLUONGDAXUAT ,CT.DIENGIAINGHIEPVUPHATSINH FROM TT_NOITRU_KHAMBENH KB INNER JOIN TT_NOITRU_TOATHUOC tnt ON KB.KHAMBENH_ID = tnt.KHAMBENH_ID INNER JOIN TT_TIEPNHAN TN ON tnt.TIEPNHAN_ID = TN.TIEPNHAN_ID INNER JOIN TT_BENHNHAN tb ON TN.BENHNHAN_ID = tb.BENHNHAN_ID LEFT JOIN (SELECT LOAI = N'Phiếu lĩnh' ,MA = 'PL' ,CT.SOLONHAP_ID ,FORMAT(PL.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss') AS NGAYCHUNGTU ,PL.MACHUNGTU ,PL.CHUNGTU_ID ,CT.CHUNGTUCHITIET_ID ,CAST(CT.SOLUONGYEUCAU AS DECIMAL(10, 3)) AS SOLUONGYEUCAU ,CAST(CT.SOLUONGDAXUAT AS DECIMAL(10, 3)) AS SOLUONGDAXUAT ,'' AS DIENGIAINGHIEPVUPHATSINH,CT.TOATHUOCNOITRU_ID FROM TT_DUOC_PHIEULINH_CHITIET CT INNER JOIN TT_DUOC_PHIEULINH PL ON PL.CHUNGTU_ID = CT.CHUNGTU_ID WHERE CT.TOATHUOCNOITRU_ID IN (@SLTTOATHUOC_ID) UNION ALL SELECT ld.DICTIONARY_NAME AS LOAI ,tdc.MUCDICHCHUNGTU_CODE AS MA ,CT.SOLONHAP_ID ,FORMAT(tdc.NGAYCHUNGTU, 'dd/MM/yyyy HH:mm:ss') AS NGAYCHUNGTU ,tdc.MACHUNGTU ,tdc.CHUNGTU_ID ,CT.CHUNGTUCHITIET_ID ,CAST(CT.SOLUONGYEUCAU AS DECIMAL(10, 3)) AS SOLUONGYEUCAU ,CAST(CT.SOLUONGDAXUAT AS DECIMAL(10, 3)) AS SOLUONGDAXUAT ,tdc.DIENGIAINGHIEPVUPHATSINH,CT.TOATHUOCNOITRU_ID FROM TT_DUOC_CHUNGTU_CHITIET CT (NOLOCK) INNER JOIN TT_DUOC_CHUNGTU tdc (NOLOCK) ON CT.CHUNGTU_ID = tdc.CHUNGTU_ID INNER JOIN LST_DICTIONARY ld (NOLOCK) ON ld.DICTIONARY_ID = tdc.MUCDICHCHUNGTU_ID AND ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' WHERE CT.TOATHUOCNOITRU_ID IN (@SLTTOATHUOC_ID) and tdc.MUCDICHCHUNGTU_CODE not in ('X07','N05') ) CT ON tnt.TOATHUOC_ID = CT.TOATHUOCNOITRU_ID LEFT join TM_DUOC td on tnt.DUOC_ID = td.DUOC_ID WHERE tnt.TOATHUOC_ID IN (@SLTTOATHUOC_ID)",
    "param": {
      "SLTTOATHUOC_ID": ""
    }
  },
  {
    "code": "MERGTONKHO",
    "query": "DECLARE @DUOC_ID INT  if(ISNUMERIC(@MADUOC) =1) BEGIN SET @DUOC_ID = cast(@MADUOC AS INT) END ELSE BEGIN SET @DUOC_ID = (SELECT top 1 DUOC_ID FROM TM_DUOC where MADUOC = @MADUOC) END BEGIN TRY MERGE TT_DUOC_TONKHO AS X USING ( select  aa.SoLoNhap_ID,  aa.KHODUOC_ID,  aa.DUOC_ID, aa.NGUONDUOC_ID,   aa.BENHVIEN_ID, aa.NGAYNHAP, sum(aa.soluong) as SOLUONG from ( Select ( case when CTU.LoaiChungTu = 'N' then CTU.KhoNhap_ID else ctu.KhoXuat_ID end ) as KHODUOC_ID, CT.SOLONHAP_ID, (case when CTU.LoaiChungTu = 'N' then SoLuongThucTe  else - SOLUONGDAXUAT end ) as SOLUONG, CT.DUOC_ID, Lo.NGUONDUOC_ID, CTU.BENHVIEN_ID, Lo.NGAYNHAP from TT_DUOC_CHUNGTU_CHITIET CT WITH (NOLOCK) join TT_DUOC_CHUNGTU CTU WITH (NOLOCK) on CT.ChungTu_ID = CTU.ChungTu_ID join TT_DUOC_CHUNGTU_SOLONHAP Lo WITH (NOLOCK) on Lo.SoLoNhap_ID = CT.SoLoNhap_ID join TM_DUOC duoc WITH (NOLOCK) on CT.DUOC_ID = duoc.DUOC_ID where ( ( CTU.TRANGTHAI not in ('PNCXN', 'CXN', 'HUY', 'PNCNK')) or CTU.TRANGTHAI is null ) AND  CT.DUOC_ID = @DUOC_ID ) aa where  aa.KHODUOC_ID = @KHODUOC_ID Group by   AA.SoLoNhap_ID,  AA.KHODUOC_ID, AA.DUOC_ID,  AA.NGUONDUOC_ID,  AA.BENHVIEN_ID, aa.NGAYNHAP ) AS Y ON (X.KHODUOC_ID = Y.KHODUOC_ID  AND X.SOLONHAP_ID = Y.SOLONHAP_ID AND X.DUOC_ID = Y.DUOC_ID  AND X.NGUONDUOC_ID = Y.NGUONDUOC_ID AND X.BENHVIEN_ID = Y.BENHVIEN_ID ) WHEN MATCHED THEN UPDATE SET  X.SOLUONG = Y.SOLUONG WHEN NOT MATCHED By Target THEN INSERT (KHODUOC_ID, DUOC_ID, SOLONHAP_ID, SOLUONG, NGUONDUOC_ID, BENHVIEN_ID, NGAYTAO, NGUOITAO_ID, NGAYCAPNHAT, NGUOICAPNHAT_ID  ) VALUES   (   Y.KHODUOC_ID,   Y.DUOC_ID,  Y.SOLONHAP_ID, Y.SOLUONG,  Y.NGUONDUOC_ID, Y.BENHVIEN_ID,  Y.NGAYNHAP, NULL,  GETDATE(), NULL) WHEN NOT MATCHED By Source and X.KHODUOC_ID = @KHODUOC_ID AND X.DUOC_ID = @DUOC_ID THEN Delete; END TRY BEGIN CATCH END CATCH",
    "param": {
      "MADUOC": "",
      "KHODUOC_ID": ""
    }
  },
  {
    "code": "SDATANOITRU",
    "query": "SELECT N'BIÊN BẢN HỘI CHẨN' AS LOAI, BIENBANHOICHAN_ID AS ID,SOPHIEUHOICHAN AS DATA  FROM TT_BIENBANHOICHAN WHERE BENHAN_ID = @BENHAN_ID UNION ALL select N'Y LỆNH CHĂM SÓC' AS LOAI, CHAMSOC_ID AS ID, NULL AS SOPHIEU from TT_NOITRU_CHAMSOC where BENHAN_ID = @BENHAN_ID UNION ALL SELECT N'HÓA ĐƠN' AS LOAI, HOADON_ID AS ID, SOHOADON AS SOPHIEU FROM TT_HOADON where BENHAN_ID = @BENHAN_ID and ((HUYHOADON != '1' and HOANTRA != '1' and DATHANHTOAN = 1)) UNION ALL SELECT N'CHI PHÍ' AS LOAI, VIENPHI_ID, COALESCE(DV.TENDICHVU,D.TENDUOCDAYDU,N'Giường') FROM TT_VIENPHI VP LEFT JOIN TM_DUOC D on VP.DUOC_ID = D.DUOC_ID LEFT JOIN TM_DICHVU DV ON VP.DICHVU_ID = DV.DICHVU_ID where BENHAN_ID = @BENHAN_ID",
    "param": {
      "TIEPNHAN_ID": "",
      "BENHAN_ID": ""
    }
  },
  {
    "code": "THUOCCHUALINH",
    "query": "SELECT KB.KHAMBENH_ID ,CAST(NHOMHUOCPHA AS INT) AS TPHA ,td.DUOC_ID ,td.TENDUOCDAYDU ,CAST(tnt.SOLUONGTHUCLINH AS DECIMAL(10, 3)) AS SLTHUCLINH ,tnt.TOATHUOC_ID ,tnt.TINHTIEN ,KB.LOAITOATHUOC AS LOAITT ,KB.THUOCRAVIEN AS THUOCRV ,CAST(tnt.SOLAN AS INT) AS SOLAN ,tnt.PHAMVI_ID ,tnt.PHONGBANRATOA_ID AS PBRATOA ,tp.TENPHONGBAN ,KB.KHODUOC_ID ,tk.TENKHO AS KHODUOC ,tnt.KHOTAO_ID ,tk1.TENKHO AS KHOTAO ,tnt.CHUNGTU_ID FROM TT_NOITRU_TOATHUOC tnt INNER JOIN TT_NOITRU_KHAMBENH KB ON tnt.KHAMBENH_ID = KB.KHAMBENH_ID INNER JOIN TM_DUOC td ON tnt.DUOC_ID = td.DUOC_ID LEFT JOIN TM_KHODUOC tk ON KB.KHODUOC_ID = tk.KHODUOC_ID LEFT JOIN TM_KHODUOC tk1 ON tnt.KHOTAO_ID = tk1.KHODUOC_ID LEFT JOIN TM_PHONGBAN tp ON tnt.PHONGBANRATOA_ID = tp.PHONGBAN_ID WHERE KB.KHAMBENH_ID = @KHAMBENH_ID AND tnt.COSO = '0' AND ISNULL(tnt.SOLUONGTHUCLINH, tnt.SOLUONG) > 0 AND NOT EXISTS (SELECT TOP 1 1 FROM TT_DUOC_CHUNGTU_CHITIET tdcc INNER JOIN TT_DUOC_CHUNGTU tdc ON tdcc.CHUNGTU_ID = tdc.CHUNGTU_ID AND tdc.LOAICHUNGTU = 'N' WHERE tdcc.TOATHUOCNOITRU_ID = tnt.TOATHUOC_ID AND tdc.KHONHAP_ID = tnt.KHOTAO_ID)",
    "param": {
      "KHAMBENH_ID": ""
    }
  },
  {
    "code": "SUMCHUNGTU",
    "query": "DECLARE @DUOC_ID INT  if(ISNUMERIC(@MADUOC) =1) BEGIN SET @DUOC_ID = cast(@MADUOC AS INT) END ELSE BEGIN SET @DUOC_ID = (SELECT top 1 DUOC_ID FROM TM_DUOC where MADUOC = @MADUOC) END SELECT  ld.DICTIONARY_NAME AS MUCDICHCHUNGTU,CT.MUCDICHCHUNGTU_CODE AS CODE ,tdcc.SOLONHAP_ID ,SLO.SOLOSANPHAM ,sum(case WHEN CT.LOAICHUNGTU = 'X' then -1 * tdcc.SOLUONGDAXUAT ELSE isnull(tdcc.SOLUONGDAXUAT,tdcc.SOLUONGTHUCTE) END) as SOLUONG ,KX.TENKHO AS KHOXUAT ,KN.TENKHO AS KHONHAP FROM TT_DUOC_CHUNGTU CT INNER JOIN TT_DUOC_CHUNGTU_CHITIET tdcc ON CT.CHUNGTU_ID = tdcc.CHUNGTU_ID INNER JOIN LST_DICTIONARY ld on ld.DICTIONARY_ID = CT.MUCDICHCHUNGTU_ID and ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' INNER JOIN TT_DUOC_CHUNGTU_SOLONHAP SLO on tdcc.SOLONHAP_ID = SLO.SOLONHAP_ID LEFT join TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID LEFT join TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID where tdcc.DUOC_ID = @DUOC_ID and case WHEN CT.LOAICHUNGTU = 'X' then CT.KHOXUAT_ID ELSE CT.KHONHAP_ID END = @KHODUOC_ID and ((CAST(tdcc.SOLONHAP_ID as varchar(100)) = @SOLONHAP OR SLO.SOLOSANPHAM = @SOLONHAP) OR @SOLONHAP = '') GROUP BY tdcc.SOLONHAP_ID,CT.MUCDICHCHUNGTU_CODE,ld.DICTIONARY_NAME,SLO.SOLOSANPHAM ,KX.TENKHO ,KN.TENKHO",
    "param": {
      "MADUOC": "",
      "KHODUOC_ID": ""
    }
  },
  {
    "code": "SGOI",
    "query": "SELECT G.DANGKY_ID, G.GOI_ID,tcg.TENGOI ,format(G.NGAYKICHHOAT,'dd/MM/yyyy HH:mm:ss') AS NGAYKICHHOAT,format(G.NGAYHETHANSUDUNG,'dd/MM/yyyy HH:mm:ss') AS NGAYHETHANSD ,G.TRANGTHAI AS TT_KICHHOAT,tcg.TRANGTHAI ,GCT.DICHVU_ID,td.TENDICHVU,GCT.SOLANDINHMUC,GCT.SOLANDASUDUNG,GCT.SOLANCONLAI ,GCT.DONGIATRONGGOI,GCT.THANHTIENTRONGGOI FROM TT_CSKH_GOI_DANGKY G INNER JOIN TT_CSKH_GOI_DANGKY_CHITIET GCT on G.DANGKY_ID = GCT.DANGKY_ID INNER JOIN TM_CSKH_GOI tcg ON G.GOI_ID = tcg.GOI_ID INNER JOIN TM_DICHVU td on GCT.DICHVU_ID = td.DICHVU_ID where G.BENHNHAN_ID = @BENHNHAN_ID",
    "param": {
      "BENHNHAN_ID": ""
    }
  },
  {
    "code": "SLISTCHUNGTU",
    "query": "DECLARE @DUOC_ID INT  if(ISNUMERIC(@MADUOC) =1) BEGIN SET @DUOC_ID = cast(@MADUOC AS INT) END ELSE BEGIN SET @DUOC_ID = (SELECT top 1 DUOC_ID FROM TM_DUOC where MADUOC = @MADUOC) END SELECT CT.MACHUNGTU,format(CT.NGAYCHUNGTU,'dd/MM/yyyy HH:mm:ss') AS NGAYCHUNGTU, ld.DICTIONARY_NAME AS MUCDICHCHUNGTU ,CT.MUCDICHCHUNGTU_CODE AS CODE ,tdcc.SOLONHAP_ID ,SLO.SOLOSANPHAM ,CASE WHEN CT.LOAICHUNGTU = 'X' THEN -1 * tdcc.SOLUONGDAXUAT ELSE ISNULL(tdcc.SOLUONGDAXUAT, tdcc.SOLUONGTHUCTE) END AS SOLUONG,KX.TENKHO AS KHOXUAT ,KN.TENKHO AS KHONHAP FROM TT_DUOC_CHUNGTU CT INNER JOIN TT_DUOC_CHUNGTU_CHITIET tdcc ON CT.CHUNGTU_ID = tdcc.CHUNGTU_ID INNER JOIN LST_DICTIONARY ld ON ld.DICTIONARY_ID = CT.MUCDICHCHUNGTU_ID AND ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' INNER JOIN TT_DUOC_CHUNGTU_SOLONHAP SLO ON tdcc.SOLONHAP_ID = SLO.SOLONHAP_ID LEFT JOIN TM_KHODUOC KX ON CT.KHOXUAT_ID = KX.KHODUOC_ID LEFT JOIN TM_KHODUOC KN ON CT.KHONHAP_ID = KN.KHODUOC_ID WHERE tdcc.DUOC_ID = @DUOC_ID AND CASE WHEN CT.LOAICHUNGTU = 'X' THEN CT.KHOXUAT_ID ELSE CT.KHONHAP_ID END = @KHODUOC_ID AND ((CAST(tdcc.SOLONHAP_ID as varchar(100)) = @SOLONHAP OR SLO.SOLOSANPHAM = @SOLONHAP) OR @SOLONHAP = '') AND CONVERT(DATE,CT.NGAYCHUNGTU) BETWEEN CONVERT(DATE, @TUNGAY) AND CONVERT(DATE, @DENNGAY) ORDER BY CT.NGAYCHUNGTU",
    "param": {
      "KHODUOC_ID": ""
    }
  },
  {
    "code": "THUOCNT_BYCT",
    "query": "SELECT FORMAT(KB.THOIGIANKHAM, 'dd/MM/yyyy HH:mm:ss') AS THOIGIANKHAM,KB.KHAMBENH_ID, tnt.TOATHUOC_ID, td.TENDUOCDAYDU,tt.SOTIEPNHAN,tnb.SOBENHAN FROM TT_NOITRU_KHAMBENH KB INNER JOIN TT_NOITRU_TOATHUOC tnt ON KB.KHAMBENH_ID = tnt.KHAMBENH_ID INNER JOIN TT_TIEPNHAN tt on tnt.TIEPNHAN_ID = tt.TIEPNHAN_ID INNER JOIN TT_NOITRU_BENHAN tnb ON KB.BENHAN_ID = tnb.BENHAN_ID INNER JOIN TM_DUOC td ON tnt.DUOC_ID = td.DUOC_ID WHERE tnt.TOATHUOC_ID = @REF_ID",
    "param": {
      "REF_ID": ""
    }
  },
  {
    "code": "CHITIETBENHNHAN",
    "query": "SELECT BN.MAYTE ,BN.TENBENHNHAN ,G.DESCRIPTION AS  GIOITINH ,CASE WHEN BN.NGAYGIOSINH is NOT NULL THEN convert(VARCHAR(10),BN.NGAYGIOSINH,103) ELSE cast(BN.NAMSINH AS VARCHAR(10)) END AS  NGAYSINH ,dbo.TinhTuoi_V3(BN.NAMSINH,BN.NGAYGIOSINH) AS TUOI ,BN.SODIENTHOAI ,BN.SONHA ,BN.DIACHI ,BN.DIACHITHUONGTRU ,BN.DIACHILIENLAC ,BN.XAPHUONG_ID ,ld.DICTIONARY_NAME AS NGHENGHIEP ,ld1.DICTIONARY_NAME AS DANTOC ,ld2.DICTIONARY_NAME AS QUOCGIA ,ld3.DICTIONARY_NAME as NHOMMAU ,ld4.DICTIONARY_NAME AS HONNHAN ,BN.CMND ,FORMAT(BN.NGAYCAPCMND, 'dd/MM/yyyy HH:mm:ss') as NGAYCAPCMND ,BN.NOICAPGIAYTO_TEXT FROM TT_BENHNHAN BN INNER JOIN TM_GENDER G on BN.GIOITINH = G.ID LEFT join LST_DICTIONARY ld ON BN.NGHENGHIEP_ID = ld.DICTIONARY_ID and ld.DICTIONARY_TYPE_CODE = 'NgheNghiep' LEFT JOIN LST_DICTIONARY ld1 ON BN.DANTOC_ID = ld1.DICTIONARY_ID and ld1.DICTIONARY_TYPE_CODE = 'DanToc' LEFT JOIN LST_DICTIONARY ld2 ON BN.QUOCTICH_ID = ld2.DICTIONARY_ID and ld2.DICTIONARY_TYPE_CODE = 'QuocGia' LEFT JOIN LST_DICTIONARY ld3 on BN.NHOMMAU_ID = ld3.DICTIONARY_ID and ld3.DICTIONARY_TYPE_CODE = 'NhomMau' LEFT join LST_DICTIONARY ld4 ON BN.TINHTRANGHONNHAN_ID = ld4.DICTIONARY_ID where BN.BENHNHAN_ID  =@BENHNHAN_ID",
    "param": {
      "BENHNHAN_ID": ""
    }
  },
  {
    "code": "CHITIETTIEPNHAN",
    "query": "SELECT SOTIEPNHAN,FORMAT(TN.THOIGIANTIEPNHAN, 'dd/MM/yyyy HH:mm:ss')  as TGTIEPNHAN ,DT.TENDOITUONG ,NTN.TENPHONGBAN as NOITIEPNHAN ,tl.TENLYDOTIEPNHAN AS LYDOTIEPNHAN ,ld.DICTIONARY_NAME AS LOAITN ,ld1.DICTIONARY_NAME AS HTDENKHAM ,LYDODENKHAM ,CONCAT(tb.MABENHVIEN,' - ',tb.TENBENHVIEN)NOICHUYENDEN ,SOCHUYENVIEN ,KHONGSDT ,CAST(SUDUNG_BHTN AS BIT) AS BHTN ,CAST(VIP AS BIT) AS TRASAU,CAST(ISNULL(GIAYXNTHUONGBINH,0) AS BIT) AS GIAYXNTHUONGBINH ,CAST(KHOADULIEU AS BIT) as KHOA,FORMAT(TN.NGAYKHOA, 'dd/MM/yyyy HH:mm:ss')  as NGAYKHOA ,TRANGTHAI ,lg.TENLOAIGIA ,SoTT_HoSo_BHYT ,concat(td.MADOITUONGKCB,' - ',td.TENDOITUONGKCB) AS DOITUONG_130 ,MATIEMCHUNG FROM TT_TIEPNHAN TN LEFT join TM_PHONGBAN NTN ON NTN.PHONGBAN_ID = TN.NOITIEPNHAN_ID LEFT JOIN TM_DOITUONG dt ON DT.DOITUONG_ID = TN.DOITUONG_ID LEFT JOIN TM_LYDOTIEPNHAN tl ON TN.LYDOTIEPNHAN_ID = tl.LYDOTIEPNHAN_ID LEFT join LST_DICTIONARY ld ON TN.LOAITIEPNHAN_ID = ld.DICTIONARY_ID AND ld.DICTIONARY_TYPE_CODE = 'PhanLoaiTiepNhan' LEFT join LST_DICTIONARY ld1 ON TN.HINHTHUCDENKHAM_ID = ld1.DICTIONARY_ID and ld1.DICTIONARY_TYPE_CODE = 'HinhThucDenKhamBenh' LEFT join TM_BENHVIEN tb ON TN.NOIGIOITHIEU_ID = tb.BENHVIEN_STT_ID LEFT join TM_LOAIGIA LG on lg.LOAIGIA_ID = TN.LOAIGIATN_ID LEFT JOIN TM_DOITUONGKCB td ON TN.DOITUONGKCB_ID = td.DOITUONGKCB_ID WHERE TN.TIEPNHAN_ID = @TIEPNHAN_ID",
    "param": {
      "TIEPNHAN_ID": ""
    }
  },
  {
    "code": "DUPSHORTCUT",
    "query": "SELECT N'TRÙNG VALUE' AS LOAI,tn.MANHANVIEN, tn.TENNHANVIEN, sh.SHORTCUT_ID ,sh.SHORTCUT_CODE ,sh.SHORTCUT_VALUE ,sh.USER_ID ,sh.TAMNGUNG FROM TM_SHORTCUT sh INNER JOIN (SELECT ts.SHORTCUT_VALUE, USER_ID from TM_SHORTCUT ts group BY USER_ID, ts.SHORTCUT_VALUE HAVING COUNT(ts.SHORTCUT_ID) > 1 ) a on a.USER_ID = sh.USER_ID AND sh.SHORTCUT_VALUE = a.SHORTCUT_VALUE LEFT JOIN TM_NHANVIEN tn ON a.USER_ID = tn.NHANVIEN_ID LEFT join TBL_USER tu on tu.EMPLOYEEID = tn.NHANVIEN_ID where tu.ACCOUNTNAME = @KEYSEARCH UNION ALL SELECT N'TRÙNG CODE' AS LOAI,tn.MANHANVIEN, tn.TENNHANVIEN,sh.SHORTCUT_ID ,sh.SHORTCUT_CODE ,sh.SHORTCUT_VALUE ,sh.USER_ID ,sh.TAMNGUNG FROM TM_SHORTCUT sh INNER JOIN (SELECT ts.SHORTCUT_CODE, USER_ID from TM_SHORTCUT ts group BY USER_ID, ts.SHORTCUT_CODE HAVING COUNT(ts.SHORTCUT_ID) > 1 ) a on a.USER_ID = sh.USER_ID AND sh.SHORTCUT_CODE = a.SHORTCUT_CODE LEFT JOIN TM_NHANVIEN tn ON a.USER_ID = tn.NHANVIEN_ID LEFT join TBL_USER tu on tu.EMPLOYEEID = tn.NHANVIEN_ID where tu.ACCOUNTNAME = @KEYSEARCH",
    "param": {
      "KEYSEARCH": ""
    }
  },
  {
    "code": "SCAPCHUNGTU",
    "query": "SELECT CASE WHEN CTG.SOCHUNGTUGOC IS NULL THEN  N'Chứng từ gốc' ELSE N'Chứng từ liên quan' END AS LOAI, CTG.CHUNGTU_ID,CTG.MACHUNGTU,CTG.MUCDICHCHUNGTU_CODE,ld.DICTIONARY_NAME FROM TT_DUOC_CHUNGTU CTG INNER JOIN LST_DICTIONARY ld on ld.DICTIONARY_ID = CTG.MUCDICHCHUNGTU_ID and ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' WHERE CTG.MACHUNGTU = @MACHUNGTU UNION ALL SELECT N'Chứng từ liên quan' AS LOAI, CTLQ.CHUNGTU_ID,CTLQ.MACHUNGTU,CTLQ.MUCDICHCHUNGTU_CODE,ld.DICTIONARY_NAME FROM TT_DUOC_CHUNGTU CTG LEFT JOIN TT_DUOC_CHUNGTU CTLQ ON CTG.CHUNGTULIENQUAN_ID = CTLQ.CHUNGTU_ID INNER JOIN LST_DICTIONARY ld on ld.DICTIONARY_ID = CTLQ.MUCDICHCHUNGTU_ID and ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' WHERE CTG.MACHUNGTU = @MACHUNGTU UNION ALL SELECT  N'Chứng từ gốc', CTG.CHUNGTU_ID,CTG.MACHUNGTU,CTG.MUCDICHCHUNGTU_CODE,ld.DICTIONARY_NAME FROM TT_DUOC_CHUNGTU CT INNER JOIN TT_DUOC_CHUNGTU CTG on CTG.MACHUNGTU = CT.SOCHUNGTUGOC INNER JOIN LST_DICTIONARY ld on ld.DICTIONARY_ID = CTG.MUCDICHCHUNGTU_ID and ld.DICTIONARY_TYPE_CODE = 'MucDichChungTu' WHERE CT.MACHUNGTU = @MACHUNGTU",
    "param": {
      "MACHUNGTU": ""
    }
  },
  {
    "code": "ICDNGOAITRU",
    "query": "DECLARE @MA_BENH NVARCHAR(50) DECLARE @TEN_BENH_CHINH NVARCHAR(500) DECLARE @MABENH_KHAC NVARCHAR(1500) DECLARE @TEN_BENH NVARCHAR(MAX) DECLARE @PP_DIEU_TRI NVARCHAR(1000) DECLARE @ID INT= 1 DECLARE @ICDTABLE AS TABLE(ID INT,STT INT,KHAMBENH_ID INT ,ICD_ID INT , MA_ICD NVARCHAR(50), TENICD NVARCHAR(250),ISCK_CHINH BIT,IS_ICD_CHINH BIT, HUONGIAIQUYET NVARCHAR(1000)) DECLARE @TBL_KHAMBENH as TABLE (STT INT, KHAMBENH_ID INT) INSERT INTO @TBL_KHAMBENH SELECT  ROW_NUMBER() OVER (ORDER BY D.BHYT_THANHTIEN_CHITRA DESC) AS STT, D.KHAMBENH_ID FROM ( SELECT SUM(BHYT_THANHTIEN_CHITRA) AS BHYT_THANHTIEN_CHITRA ,CASE WHEN VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC' THEN VP.KHAMBENH_ID ELSE ISNULL(YC.KHAMBENH_ID, YC.KHAMBENH_NGOAITRU_ID) END AS KHAMBENH_ID FROM TT_VIENPHI VP LEFT JOIN TT_DVYEUCAU YC ON YC.DVYEUCAU_ID = VP.REF_ID AND VP.REF_TABLE = 'TT_DVYEUCAU' AND YC.BENHAN_ID is NULL WHERE VP.TIEPNHAN_ID = @TIEPNHAN_ID  and VP.REF_TABLE in ('TT_DVYEUCAU','TT_NGOAITRU_TOATHUOC') AND VP.HUY <> '1' AND (YC.KHAMBENH_ID IS NOT NULL OR YC.KHAMBENH_NGOAITRU_ID IS NOT NULL OR VP.KHAMBENH_ID IS NOT NULL) GROUP BY CASE WHEN VP.REF_TABLE = 'TT_NGOAITRU_TOATHUOC' THEN VP.KHAMBENH_ID ELSE ISNULL(YC.KHAMBENH_ID, YC.KHAMBENH_NGOAITRU_ID) END ) D INSERT INTO @ICDTABLE (ID,STT, KHAMBENH_ID, ICD_ID, MA_ICD, TENICD, ISCK_CHINH, IS_ICD_CHINH, HUONGIAIQUYET) SELECT TOP 1 @ID, A.STT,KB.KHAMBENH_ID,ICD.ICD_ID,ICD.MAICD,ICD.TENICD,1,1,ld.DICTIONARY_NAME FROM TT_NGOAITRU_KHAMBENH KB INNER JOIN @TBL_KHAMBENH A on KB.KHAMBENH_ID = A.KHAMBENH_ID AND A.STT = 1 INNER JOIN LST_DICTIONARY ld ON KB.HUONGGIAIQUYET_ID = ld.DICTIONARY_ID AND ld.DICTIONARY_TYPE_CODE = 'GiaiQuyetKhamBenh' LEFT JOIN TM_ICD ICD ON KB.CHANDOANICD_ID = ICD.ICD_ID WHERE KB.TIEPNHAN_ID = @TIEPNHAN_ID AND ISNULL(ICD.KHONGDUNG_BHYT, '0') = '0' INSERT INTO @ICDTABLE (ID,STT, KHAMBENH_ID, ICD_ID, MA_ICD, TENICD, ISCK_CHINH, IS_ICD_CHINH, HUONGIAIQUYET) SELECT @ID + ROW_NUMBER() OVER (ORDER BY A.STT), A.STT,k.KHAMBENH_ID, dm.ICD_ID,dm.MAICD,dm.TENICD,0,1,null FROM TT_NGOAITRU_KHAMBENH k INNER JOIN @TBL_KHAMBENH A ON k.KHAMBENH_ID = A.KHAMBENH_ID and A.STT <> 1 LEFT JOIN TM_ICD dm ON k.CHANDOANICD_ID = dm.ICD_ID WHERE k.TIEPNHAN_ID = @TIEPNHAN_ID AND ISNULL(dm.KHONGDUNG_BHYT, '0') = '0' set @ID = (SELECT count(1) FROM @ICDTABLE) INSERT INTO @ICDTABLE (ID,STT, KHAMBENH_ID, ICD_ID, MA_ICD, TENICD, ISCK_CHINH, IS_ICD_CHINH, HUONGIAIQUYET) SELECT @ID + ROW_NUMBER() OVER (ORDER BY A.STT), A.STT ,A.KHAMBENH_ID, dm.ICD_ID,dm.MAICD,dm.TENICD,0,0,null FROM TT_NGOAITRU_KHAMBENH_ICD i INNER JOIN  @TBL_KHAMBENH A ON i.KHAMBENH_ID = A.KHAMBENH_ID LEFT JOIN TM_ICD dm ON i.ICD_ID = dm.ICD_ID WHERE ISNULL(DM.KHONGDUNG_BHYT, '0') = '0' AND NOT EXISTS (SELECT TOP 1 1 FROM @ICDTABLE WHERE ISCK_CHINH = 1 AND IS_ICD_CHINH = 1 AND ICD_ID = dm.ICD_ID); WITH CTE AS ( SELECT ID,ICD_ID,ROW_NUMBER() OVER (PARTITION BY ICD_ID ORDER BY STT) AS row_num FROM @ICDTABLE WHERE ISCK_CHINH <> 1 ) DELETE FROM @ICDTABLE WHERE ID IN (SELECT ID FROM CTE WHERE row_num > 1); SELECT A.ID ,A.STT ,A.KHAMBENH_ID,td.TENDICHVU ,A.ICD_ID ,A.MA_ICD ,A.TENICD ,A.ISCK_CHINH ,A.IS_ICD_CHINH ,A.HUONGIAIQUYET FROM @ICDTABLE A INNER JOIN TT_NGOAITRU_KHAMBENH KB on A.KHAMBENH_ID = KB.KHAMBENH_ID INNER JOIN TM_DICHVU td on KB.DICHVU_ID = td.DICHVU_ID"
  },
  {
    "code": "CKCHUAXNBHYT",
    "query": "SELECT DISTINCT B.TIEPNHAN_ID ,B.SOTIEPNHAN ,FORMAT(B.THOIGIANTIEPNHAN,'dd/MM/yyyy HH:mm:ss') TGTIEPNHAN ,td.TENDOITUONG ,C.MAYTE AS MABN ,C.TENBENHNHAN ,CASE WHEN ISNULL(D.XACNHANCHIPHI_ID, 0) > 0 THEN N'Đã xác nhận' ELSE N'Chưa xác nhận' END TRANGTHAI FROM TT_TIEPNHAN B INNER JOIN TT_BENHNHAN C ON B.BENHNHAN_ID = C.BENHNHAN_ID LEFT JOIN TT_XACNHANCHIPHI D ON D.TIEPNHAN_ID = B.TIEPNHAN_ID LEFT JOIN TM_DOITUONG td on td.DOITUONG_ID = b.DOITUONG_ID WHERE ( NOT EXISTS (SELECT TIEPNHAN_ID FROM TT_NOITRU_BENHAN WHERE TIEPNHAN_ID = B.TIEPNHAN_ID) ) AND ( B.TRANGTHAI = 'DATIEPNHAN' OR B.TRANGTHAI = 'HOANTHANH' ) AND B.SOBHYT = @SOTHE AND D.XACNHANCHIPHI_ID IS NULL AND EXISTS (SELECT 1 FROM TT_VIENPHI WHERE TIEPNHAN_ID = B.TIEPNHAN_ID AND BHYT_DONGIA_CHITRA > 0 AND HUY != 1)"
  },
  {
    "code": "TENBHBYCK",
    "query": "SELECT td.TENDICHVU,data.* FROM ( SELECT max(DICHVU_ID) AS DICHVU_ID,THONGTUBOYTE,TEN_BHYT,a.CHUYENKHOA_ID,tc.TENCHUYENKHOA FROM dbo.TM_DICHVU a LEFT join TM_CHUYENKHOA tc ON a.CHUYENKHOA_ID = tc.CHUYENKHOA_ID WHERE len(TEN_BHYT) > 0  and BHYT = '1' and a.CHUYENKHOA_ID is NOT NULL and ISNULL(a.TAMNGUNG,'0') <> '1' and ( tc.TENCHUYENKHOA LIKE N'%' + @TEXT + '%' OR @TEXT is null) GROUP BY a.CHUYENKHOA_ID,TEN_BHYT,THONGTUBOYTE,tc.TENCHUYENKHOA ) data LEFT join TM_DICHVU td ON data.DICHVU_ID = td.DICHVU_ID"
  },
  {
    "code": "DMNHANVIEN",
    "query": "SELECT tn.NHANVIEN_ID ,tn.MANHANVIEN ,tn.TENNHANVIEN ,concat(tn.NHOMCHUCDANH_ID,' - ',ld.DICTIONARY_NAME) as NHOM_CHUCDANH,ld1.DICTIONARY_NAME as CHUCVU,ld2.DICTIONARY_NAME as CHUCDANH ,concat(tn.PHONGBAN_ID,' - ',tp.TENPHONGBAN) AS PHONGBAN ,tn.MA_BAC_SI AS CCHN ,tn.MADINHDANH ,cast(tn.TAMNGUNG AS BIT) TAMNGUNG FROM TM_NHANVIEN tn LEFT JOIN LST_DICTIONARY ld on tn.NHOMCHUCDANH_ID = ld.DICTIONARY_CODE and ld.DICTIONARY_TYPE_CODE = 'NhomChucDanh' LEFT join TM_PHONGBAN tp on tn.PHONGBAN_ID = tp.PHONGBAN_ID LEFT JOIN LST_DICTIONARY ld1 on tn.CHUCVU_ID = ld1.DICTIONARY_ID and ld1.DICTIONARY_TYPE_CODE = 'ChucVu' LEFT JOIN LST_DICTIONARY ld2 on tn.CHUCDANH_ID = ld2.DICTIONARY_ID and ld2.DICTIONARY_TYPE_CODE = 'ChucDanh' WHERE tn.MANHANVIEN LIKE N'%' + @TEXT + '%' or tn.TENNHANVIEN LIKE N'%' + @TEXT + '%' OR tn.MA_BAC_SI LIKE N'%' + @TEXT + '%' or tn.MADINHDANH LIKE N'%' + @TEXT + '%'",
    "param": {
      "TEXT": ""
    }
  }
]